<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerenciador de Produtos Mobile</title>
    <!-- Carrega Tailwind CSS para estilização moderna e responsiva -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Configuração de fontes Tailwind -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <style>
        /* Estilos básicos para garantir a altura mínima da tela */
        #root {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        /* Estilo para ocultar o input de arquivo */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border-width: 0;
        }
    </style>

    <!-- Carrega React, ReactDOM e Babel para compilar o JSX em tempo de execução -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Carrega Módulos do Firebase (usando 'type="module"' e Babel) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, deleteDoc, onSnapshot, collection, query, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Expondo funções e variáveis para o escopo global para serem usadas pelo código Babel
        window.firebase = { 
            initializeApp, getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, 
            getFirestore, doc, setDoc, deleteDoc, onSnapshot, collection, query, updateDoc 
        };
        
        // Define as configurações globais (devem ser acessíveis pelo script React/Babel)
        window.__firebase_config = typeof __firebase_config !== 'undefined' ? __firebase_config : '{}';
        window.__initial_auth_token = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        window.__app_id = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        // Inicia a aplicação React após carregar todos os scripts
        window.addEventListener('load', () => {
            const rootElement = document.getElementById('root');
            if (rootElement) {
                // Utiliza a API moderna de React 18: createRoot
                const root = ReactDOM.createRoot(rootElement);
                root.render(React.createElement(App));
            }
        });
    </script>
</head>
<body class="bg-gray-100 font-sans">
    <div id="root">
        <!-- O conteúdo da aplicação React será renderizado aqui -->
        <div class="flex items-center justify-center min-h-screen">
             <div class="text-xl text-gray-700">Carregando módulos...</div>
        </div>
    </div>

    <!-- O CÓDIGO REACT/JSX VAI AQUI, COMPILADO PELO BABEL -->
    <script type="text/babel">
        const { useState, useEffect, useCallback } = React;
        
        // --- CONFIGURAÇÕES E UTILS DO FIREBASE (Usando variáveis globais definidas acima) ---
        const firebaseConfig = JSON.parse(window.__firebase_config);
        const initialAuthToken = window.__initial_auth_token;
        const appId = window.__app_id;

        const { 
            initializeApp, getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, 
            getFirestore, doc, setDoc, deleteDoc, onSnapshot, collection, query, updateDoc 
        } = window.firebase;

        // Define a estrutura inicial de um produto
        const initialProductState = {
            id: null,
            nome: '',
            descricao: '',
            preco: 0.0,
            imageUrl: '',
        };

        // Mock de função de upload (substitua pelo Firebase Storage na produção real)
        const mockUploadImage = (file) => {
            return new Promise((resolve) => {
                setTimeout(() => {
                    console.log(`Simulando upload do arquivo: ${file.name}`);
                    const placeholderText = encodeURIComponent(file.name.substring(0, 10) || 'Produto');
                    resolve(`https://placehold.co/400x300/a3e635/1a2e05?text=${placeholderText}`);
                }, 1000);
            });
        };

        const Header = ({ userId }) => (
            <header className="bg-gray-800 p-4 shadow-lg">
                <div className="flex justify-between items-center max-w-7xl mx-auto">
                    <h1 className="text-3xl font-extrabold text-white tracking-wider">
                        Gerenciador de Produtos
                    </h1>
                    <div className="text-sm text-gray-400 p-2 border border-gray-600 rounded-lg">
                        Usuário: <span className="font-mono text-yellow-400 break-all">{userId}</span>
                    </div>
                </div>
            </header>
        );

        // Componente principal
        function App() {
            const [products, setProducts] = useState([]);
            const [db, setDb] = useState(null);
            const [userId, setUserId] = useState(null);
            const [loading, setLoading] = useState(true);
            const [isModalOpen, setIsModalOpen] = useState(false);
            
            // Estado para o produto que está sendo editado/criado
            const [currentProduct, setCurrentProduct] = useState(initialProductState);
            // Estado para o novo arquivo de imagem selecionado
            const [fileToUpload, setFileToUpload] = useState(null);

            // 1. Inicialização do Firebase e Autenticação
            useEffect(() => {
                try {
                    const app = initializeApp(firebaseConfig);
                    const firestore = getFirestore(app);
                    const authService = getAuth(app);
                    
                    setDb(firestore);

                    const unsubscribe = onAuthStateChanged(authService, async (user) => {
                        if (user) {
                            setUserId(user.uid);
                            setLoading(false);
                        } else {
                            if (initialAuthToken) {
                                await signInWithCustomToken(authService, initialAuthToken);
                            } else {
                                const userCredential = await signInAnonymously(authService);
                                setUserId(userCredential.user.uid);
                            }
                            setLoading(false);
                        }
                    });

                    return () => unsubscribe();
                } catch (e) {
                    console.error("Erro ao inicializar Firebase:", e);
                    setLoading(false);
                }
            }, []);

            // 2. Listener do Firestore (Busca em tempo real)
            useEffect(() => {
                if (!db || !userId) return;

                const productsPath = `/artifacts/${appId}/users/${userId}/products`;
                const q = query(collection(db, productsPath));

                const unsubscribe = onSnapshot(q, (snapshot) => {
                    const productsData = [];
                    snapshot.forEach((doc) => {
                        productsData.push({ id: doc.id, ...doc.data() });
                    });
                    setProducts(productsData.sort((a, b) => a.nome.localeCompare(b.nome)));
                }, (error) => {
                    console.error("Erro ao carregar produtos:", error);
                });

                return () => unsubscribe();
            }, [db, userId]);

            // Função para abrir o modal em modo de Edição ou Criação
            const handleEdit = useCallback(async (product = initialProductState) => {
                if (product.id) {
                    setCurrentProduct({ ...product, preco: parseFloat(product.preco) || 0.0 });
                } else {
                    setCurrentProduct(initialProductState);
                }
                setFileToUpload(null);
                setIsModalOpen(true);
            }, []);

            // Função que lida com a seleção de um novo arquivo
            const handleFileChange = (e) => {
                const file = e.target.files[0];
                if (file) {
                    setFileToUpload(file);
                } else {
                    setFileToUpload(null);
                }
            };
            
            // Função que lida com o save/update (Onde a mágica da foto acontece!)
            const handleSaveProduct = async (e) => {
                e.preventDefault();
                if (!db || !userId || !currentProduct.nome) return;

                setLoading(true);
                let updatedImageUrl = currentProduct.imageUrl;
                
                // PASSO 1: Lidar com o Upload da Imagem, se um novo arquivo foi selecionado
                if (fileToUpload) {
                    try {
                        console.log("Iniciando upload para o novo/atualizado produto...");
                        updatedImageUrl = await mockUploadImage(fileToUpload);
                        console.log(`URL de Imagem obtida: ${updatedImageUrl}`);
                    } catch (error) {
                        console.error("Erro no upload da imagem:", error);
                        setLoading(false);
                        return; 
                    }
                }
                
                // Prepara os dados para o Firestore
                const productDataToSave = {
                    nome: currentProduct.nome.trim(),
                    descricao: currentProduct.descricao.trim(),
                    preco: parseFloat(currentProduct.preco) || 0.0,
                    imageUrl: updatedImageUrl,
                    updatedAt: new Date(),
                };
                
                const productsPath = `/artifacts/${appId}/users/${userId}/products`;
                
                try {
                    if (currentProduct.id) {
                        // Se tem ID, é uma ATUALIZAÇÃO
                        const productRef = doc(db, productsPath, currentProduct.id);
                        await updateDoc(productRef, productDataToSave);
                        console.log("Produto atualizado com sucesso!");
                    } else {
                        // Se NÃO tem ID, é uma CRIAÇÃO
                        const newProductRef = doc(collection(db, productsPath));
                        await setDoc(newProductRef, { 
                            ...productDataToSave, 
                            createdAt: new Date() 
                        });
                        console.log("Produto criado com sucesso!");
                    }

                    // Limpa e fecha o modal
                    setIsModalOpen(false);
                    setFileToUpload(null);
                    setCurrentProduct(initialProductState);
                } catch (error) {
                    console.error("Erro ao salvar o produto:", error);
                } finally {
                    setLoading(false);
                }
            };

            // Função para deletar produto
            const handleDelete = async (id) => {
                if (!db || !userId || !window.confirm("Tem certeza que deseja deletar este produto?")) return;

                setLoading(true);
                try {
                    const productsPath = `/artifacts/${appId}/users/${userId}/products`;
                    const productRef = doc(db, productsPath, id);
                    await deleteDoc(productRef);
                    console.log(`Produto ${id} deletado.`);
                } catch (error) {
                    console.error("Erro ao deletar produto:", error);
                } finally {
                    setLoading(false);
                }
            };
            
            if (loading || !userId) {
                return (
                <div className="flex items-center justify-center min-h-screen bg-gray-100">
                    <div className="text-xl text-gray-700">Carregando aplicação...</div>
                </div>
                );
            }

            return (
                <div className="min-h-screen bg-gray-100 font-sans flex flex-col">
                    <Header userId={userId} />

                    <main className="max-w-7xl mx-auto p-4 sm:p-6 lg:p-8 flex-grow w-full">
                        <div className="flex justify-between items-center mb-6">
                            <h2 className="text-2xl font-semibold text-gray-900">Estoque ({products.length})</h2>
                            <button
                                onClick={() => handleEdit(initialProductState)}
                                className="px-6 py-2 bg-green-600 text-white font-bold rounded-lg shadow-lg hover:bg-green-700 transition duration-300"
                            >
                                + Novo Produto
                            </button>
                        </div>

                        {products.length === 0 ? (
                            <div className="text-center py-10 bg-white rounded-xl shadow-md">
                                <p className="text-gray-500">Nenhum produto cadastrado ainda. Comece a adicionar!</p>
                            </div>
                        ) : (
                            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                                {products.map((product) => (
                                    <ProductCard 
                                        key={product.id} 
                                        product={product} 
                                        onEdit={() => handleEdit(product)} 
                                        onDelete={() => handleDelete(product.id)}
                                    />
                                ))}
                            </div>
                        )}
                    </main>
                    
                    {isModalOpen && (
                        <ProductModal
                            product={currentProduct}
                            fileToUpload={fileToUpload}
                            onClose={() => {
                                setIsModalOpen(false);
                                setFileToUpload(null);
                            }}
                            onSave={handleSaveProduct}
                            onProductChange={setCurrentProduct}
                            onFileChange={handleFileChange}
                        />
                    )}
                    {loading && <LoadingOverlay />}
                </div>
            );
        }

        // Componente para exibir o produto na lista
        const ProductCard = ({ product, onEdit, onDelete }) => (
            <div className="bg-white rounded-xl shadow-lg overflow-hidden transition duration-300 hover:shadow-xl flex flex-col">
                <div className="relative h-48 bg-gray-200">
                    <img 
                        src={product.imageUrl || "https://placehold.co/400x300/e5e7eb/4b5563?text=SEM+FOTO"} 
                        alt={`Imagem de ${product.nome}`} 
                        className="w-full h-full object-cover"
                        onError={(e) => { e.target.onerror = null; e.target.src="https://placehold.co/400x300/e5e7eb/4b5563?text=ERRO+NA+FOTO"; }}
                    />
                </div>
                <div className="p-4 flex flex-col flex-grow">
                    <h3 className="text-xl font-bold text-gray-900 mb-2 truncate">{product.nome}</h3>
                    <p className="text-2xl font-extrabold text-green-700 mb-3">
                        R$ {parseFloat(product.preco).toFixed(2).replace('.', ',')}
                    </p>
                    <p className="text-sm text-gray-600 flex-grow mb-4 line-clamp-2">{product.descricao || 'Sem descrição.'}</p>
                    <div className="flex justify-end space-x-2 mt-auto">
                        <button
                            onClick={onEdit}
                            className="flex-1 py-2 bg-yellow-500 text-white font-semibold rounded-lg hover:bg-yellow-600 transition duration-200 text-sm"
                        >
                            Editar
                        </button>
                        <button
                            onClick={onDelete}
                            className="flex-1 py-2 bg-red-600 text-white font-semibold rounded-lg hover:bg-red-700 transition duration-200 text-sm"
                        >
                            Deletar
                        </button>
                    </div>
                </div>
            </div>
        );

        // Componente Modal para Adição/Edição de Produto
        const ProductModal = ({ product, fileToUpload, onClose, onSave, onProductChange, onFileChange }) => {
            const isEditing = !!product.id;
            const isNewFileSelected = !!fileToUpload;
            
            const [localPreviewUrl, setLocalPreviewUrl] = useState(product.imageUrl);

            useEffect(() => {
                let url;
                if (fileToUpload) {
                    url = URL.createObjectURL(fileToUpload);
                    setLocalPreviewUrl(url);
                } else {
                    setLocalPreviewUrl(product.imageUrl);
                }

                // Garante que a URL temporária seja revogada
                return () => {
                    if (url) {
                        URL.revokeObjectURL(url);
                    }
                };
            }, [fileToUpload, product.imageUrl]);

            return (
                <div className="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 z-50 overflow-y-auto">
                    <div className="bg-white rounded-xl shadow-2xl w-full max-w-lg transition-all transform duration-300">
                        <div className="p-6 border-b">
                            <h3 className="text-2xl font-bold text-gray-800">
                                {isEditing ? 'Editar Produto' : 'Novo Produto'}
                            </h3>
                        </div>
                        <form onSubmit={onSave} className="p-6 space-y-4">
                            
                            {/* SEÇÃO DA IMAGEM */}
                            <div className="space-y-3 p-4 bg-gray-50 rounded-lg border">
                                <label className="block text-sm font-medium text-gray-700">
                                    Foto do Produto
                                </label>
                                <div className="flex items-center space-x-4">
                                    {/* Visualização da Imagem Atual/Nova (usando localPreviewUrl) */}
                                    <div className="w-24 h-24 flex-shrink-0 bg-gray-200 rounded-lg overflow-hidden border border-gray-300">
                                        <img
                                            src={localPreviewUrl || "https://placehold.co/96x96/e5e7eb/4b5563?text=?"}
                                            alt="Pré-visualização"
                                            className="w-full h-full object-cover"
                                        />
                                    </div>

                                    {/* Input de Arquivo */}
                                    <div className="flex-grow">
                                        <label 
                                            htmlFor="file-upload" 
                                            className="cursor-pointer inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-indigo-600 hover:bg-indigo-700 focus-within:outline-none focus-within:ring-2 focus-within:ring-offset-2 focus-within:ring-indigo-500 transition"
                                        >
                                            {isEditing && product.imageUrl && !isNewFileSelected 
                                                ? 'Alterar Foto' 
                                                : (isEditing && !product.imageUrl && !isNewFileSelected 
                                                    ? 'Adicionar Foto' 
                                                    : 'Selecionar Arquivo'
                                                )
                                            }
                                        </label>
                                        <input
                                            id="file-upload"
                                            type="file"
                                            accept="image/*"
                                            onChange={onFileChange}
                                            className="sr-only"
                                        />
                                        {isNewFileSelected && (
                                            <p className="mt-1 text-sm text-green-600">
                                                Novo arquivo selecionado: <span className="font-semibold">{fileToUpload.name}</span>
                                            </p>
                                        )}
                                        {isEditing && product.imageUrl && !isNewFileSelected && (
                                            <p className="mt-1 text-sm text-gray-500">
                                                Foto atual carregada.
                                            </p>
                                        )}
                                    </div>
                                </div>
                            </div>
                            {/* FIM SEÇÃO DA IMAGEM */}

                            <div>
                                <label htmlFor="nome" className="block text-sm font-medium text-gray-700">
                                    Nome do Produto*
                                </label>
                                <input
                                    id="nome"
                                    type="text"
                                    required
                                    value={product.nome}
                                    onChange={(e) => onProductChange({ ...product, nome: e.target.value })}
                                    className="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2"
                                />
                            </div>

                            <div>
                                <label htmlFor="preco" className="block text-sm font-medium text-gray-700">
                                    Preço (R$)*
                                </label>
                                <input
                                    id="preco"
                                    type="number"
                                    step="0.01"
                                    min="0"
                                    required
                                    value={product.preco}
                                    onChange={(e) => onProductChange({ ...product, preco: e.target.value })}
                                    className="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2"
                                />
                            </div>
                            
                            <div>
                                <label htmlFor="descricao" className="block text-sm font-medium text-gray-700">
                                    Descrição
                                </label>
                                <textarea
                                    id="descricao"
                                    value={product.descricao}
                                    onChange={(e) => onProductChange({ ...product, descricao: e.target.value })}
                                    rows="3"
                                    className="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 resize-none"
                                ></textarea>
                            </div>

                            <div className="flex justify-end space-x-3 pt-4">
                                <button
                                    type="button"
                                    onClick={onClose}
                                    className="px-4 py-2 border border-gray-300 rounded-lg shadow-sm text-sm font-medium text-gray-700 hover:bg-gray-50 transition"
                                >
                                    Cancelar
                                </button>
                                <button
                                    type="submit"
                                    className="px-4 py-2 border border-transparent rounded-lg shadow-sm text-sm font-medium text-white bg-green-600 hover:bg-green-700 transition"
                                >
                                    {isEditing ? 'Salvar Alterações' : 'Cadastrar Produto'}
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            );
        };

        // Componente para sobreposição de carregamento
        const LoadingOverlay = () => (
            <div className="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50">
                <div className="flex flex-col items-center p-6 bg-white rounded-lg shadow-xl">
                    <svg className="animate-spin -ml-1 mr-3 h-8 w-8 text-indigo-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
                        <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    <p className="mt-3 text-gray-700 font-medium">Processando...</p>
                </div>
            </div>
        );
    </script>
</body>
</html>
