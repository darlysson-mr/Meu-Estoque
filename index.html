<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Estoque Pessoal - Controle com Scanner</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Configuração de cores do Tailwind para Pink/Magenta -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary-pink': '#e91e63', // Rosa vibrante (Destaque Méliuz)
                        'soft-pink': '#f8bbd0',
                        'light-bg': '#f5f5f5', // Fundo bem claro
                        'dark-text': '#262626',
                    }
                }
            }
        }
    </script>
    <!-- Bibliotecas de IA (TensorFlow.js) -->
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest/dist/tf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd@latest/dist/coco-ssd.min.js"></script>
    <!-- Biblioteca para leitura de QR Code -->
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <!-- Ícones (Lucide) -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- Configurações de PWA/Ícone -->
    <link rel="icon" href="favicon.png" type="image/png">
    <link rel="apple-touch-icon" href="favicon.png"> 
    <link rel="manifest" href="manifest.json">

    <style>
        html, body { height: 100%; font-family: 'Inter', sans-serif; }
        body { background-color: #f5f5f5; color: #262626; }
        /* Estilos do Scanner QR */
        #qr-reader { width: 100%; max-width: 400px; border-radius: 8px; overflow: hidden; border: 2px solid #e91e63; }
        .fade-in { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        /* Estilos para o modal e inputs */
        #ai-modal, #category-modal, #edit-modal { background-color: rgba(0, 0, 0, 0.8); }
        #video-container { position: relative; }
        #ai-canvas { position: absolute; top: 0; left: 0; }
        input:not([type="checkbox"]), select {
            border: 1px solid #e5e7eb !important;
            background-color: white !important;
            color: #262626 !important;
        }
        .product-image {
            width: 48px; 
            height: 48px; 
            object-fit: cover;
            border-radius: 6px;
        }
    </style>
</head>
<body class="flex flex-col min-h-screen">
    <div class="container mx-auto p-0 flex-grow">
        
        <!-- HEADER (Com o Novo Logo SVG) -->
        <header class="bg-white shadow-md mb-4 sticky top-0 z-10">
            <div class="p-4 flex justify-between items-center border-b border-gray-100">
                
                <!-- NOVO LOGO INLINE SVG -->
                <h1 class="text-2xl font-bold text-primary-pink flex items-center">
                    <svg width="32" height="32" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" class="mr-2">
                        <!-- Fundo da Caixa (Estoque) -->
                        <rect x="3" y="6" width="18" height="15" rx="2" fill="#e91e63" fill-opacity="0.1"/>
                        <!-- Borda da Caixa -->
                        <path d="M21 15V6L12 3L3 6V15" stroke="#e91e63" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        <!-- Checkmark (Controle) -->
                        <path d="M8 12L12 16L18 10" stroke="#e91e63" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        <text x="50%" y="100%" dominant-baseline="central" text-anchor="middle" font-size="0" fill="#e91e63"></text>
                    </svg>
                    Stock
                </h1>
                
                <div class="flex items-center space-x-3 text-dark-text">
                    <i data-lucide="bell" id="alert-icon" class="w-6 h-6 hover:text-primary-pink cursor-pointer text-gray-400"></i>
                    <i data-lucide="settings" id="open-settings-btn" class="w-6 h-6 hover:text-primary-pink cursor-pointer"></i>
                </div>
            </div>

            <!-- Barra de Busca -->
            <div class="p-4 bg-light-bg">
                <div class="relative">
                    <input type="text" id="product-search" placeholder="Busque por produtos, IDs ou categorias..." class="w-full bg-white border border-gray-200 rounded-lg py-2 pl-10 pr-4 text-dark-text focus:ring-2 focus:ring-primary-pink focus:outline-none transition shadow-inner">
                    <i data-lucide="search" class="w-5 h-5 absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                </div>
            </div>
        </header>

        <main class="grid grid-cols-1 lg:grid-cols-2 gap-6 p-4 md:p-6">
            
            <!-- COLUNA DE CADASTRO E ESTOQUE -->
            <div class="bg-white p-6 rounded-xl shadow-lg">

                <!-- AÇÕES RÁPIDAS (AGORA FUNCIONAIS) -->
                <h2 class="text-xl font-semibold mb-3 border-b border-gray-100 pb-2 text-dark-text flex items-center">
                    <i data-lucide="zap" class="mr-2 text-primary-pink w-5 h-5"></i> Ações Rápidas
                </h2>
                <div class="grid grid-cols-4 gap-4 mb-8 text-center">
                    <!-- Cadastrar IA/Foto -->
                    <button id="ai-register-btn-quick" title="Cadastrar com Foto (IA)" class="flex flex-col items-center p-2 rounded-lg hover:bg-soft-pink/30 transition text-dark-text">
                        <i data-lucide="camera" class="w-7 h-7 text-primary-pink mb-1"></i>
                        <span class="text-xs font-medium">Cad. Foto</span>
                    </button>
                    <!-- Scanner -->
                    <button id="start-scan-btn-quick" title="Iniciar Scanner" class="flex flex-col items-center p-2 rounded-lg hover:bg-soft-pink/30 transition text-dark-text">
                        <i data-lucide="scan-line" class="w-7 h-7 text-primary-pink mb-1"></i>
                        <span class="text-xs font-medium">Scanner</span>
                    </button>
                    <!-- Estoque Geral -->
                    <button id="manual-entry-btn" title="Ver Estoque" class="flex flex-col items-center p-2 rounded-lg hover:bg-soft-pink/30 transition text-dark-text">
                        <i data-lucide="package" class="w-7 h-7 text-primary-pink mb-1"></i>
                        <span class="text-xs font-medium">Ver Estoque</span>
                    </button>
                    <!-- Alerta Estoque Baixo -->
                    <button id="low-stock-alert-btn" title="Estoque Baixo" class="flex flex-col items-center p-2 rounded-lg hover:bg-red-500/30 transition text-dark-text">
                        <i data-lucide="alert-triangle" class="w-7 h-7 text-red-500 mb-1"></i>
                        <span class="text-xs font-medium">Alertas</span>
                    </button>
                </div>

                <!-- Formulário de Cadastro -->
                <h2 class="text-xl font-semibold mb-4 border-b border-gray-100 pb-2 text-dark-text flex items-center">
                    <i data-lucide="plus-circle" class="mr-2 w-5 h-5 text-primary-pink"></i> Novo Produto
                </h2>
                <div class="space-y-4">
                    
                    <!-- Campo de Nome e Botão de Foto -->
                    <div>
                        <label for="product-name" class="block text-sm font-medium text-dark-text mb-1">Nome do Produto (Ex: Tassel Vermelho)</label>
                        <div class="flex items-center gap-2">
                            <input type="text" id="product-name" placeholder="Nome + Cor/Variação" class="w-full rounded-lg px-3 py-2 focus:ring-2 focus:ring-primary-pink focus:outline-none transition shadow-sm">
                            <button id="ai-register-btn" title="Cadastrar com Foto (IA)" class="bg-primary-pink/10 hover:bg-primary-pink/20 p-2 rounded-lg transition text-primary-pink font-semibold flex items-center gap-1">
                                <i data-lucide="camera" class="w-5 h-5"></i> Foto
                            </button>
                        </div>
                    </div>
                    
                    <!-- Preview da Foto Capturada -->
                    <div id="image-preview-container" class="hidden">
                         <p class="text-sm font-medium text-dark-text mb-1 flex items-center gap-1">
                            <i data-lucide="image" class="w-4 h-4"></i> Foto Anexada:
                            <button id="remove-image-btn" class="ml-auto text-xs text-red-500 hover:underline">Remover</button>
                        </p>
                        <img id="image-preview" src="" alt="Preview da Foto" class="product-image w-20 h-20 shadow-md">
                    </div>

                    <!-- Qtd. Inicial e Qtd. Mínima -->
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label for="product-qty" class="block text-sm font-medium text-dark-text mb-1">Qtd. Inicial</label>
                            <input type="number" id="product-qty" value="1" min="0" class="w-full rounded-lg px-3 py-2 focus:ring-2 focus:ring-primary-pink focus:outline-none transition shadow-sm">
                        </div>
                        <div>
                            <label for="min-alert-qty" class="block text-sm font-medium text-dark-text mb-1">Qtd. Mínima p/ Alerta</label>
                            <input type="number" id="min-alert-qty" value="3" min="1" class="w-full rounded-lg px-3 py-2 focus:ring-2 focus:ring-primary-pink focus:outline-none transition shadow-sm">
                        </div>
                    </div>

                    <!-- Categoria -->
                    <div>
                         <label for="product-category" class="block text-sm font-medium text-dark-text mb-1">Categoria</label>
                         <div class="flex gap-2">
                             <select id="product-category" class="flex-grow rounded-lg px-3 py-2 focus:ring-2 focus:ring-primary-pink focus:outline-none transition shadow-sm"></select>
                             <button id="manage-categories-btn" title="Gerenciar Categorias" class="bg-gray-200 hover:bg-gray-300 p-2 rounded-lg transition text-dark-text">
                                <i data-lucide="settings-2" class="w-5 h-5"></i>
                            </button>
                         </div>
                    </div>
                    
                    <button id="add-product-btn" class="w-full bg-primary-pink hover:bg-pink-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300 flex items-center justify-center shadow-lg">
                        <i data-lucide="plus-circle" class="mr-2"></i> Adicionar Produto
                    </button>
                </div>

                <!-- Lista de Estoque -->
                <h2 class="text-xl font-semibold mt-8 mb-4 border-b border-gray-100 pb-2 text-dark-text flex items-center">
                    <i data-lucide="list" class="mr-2 w-5 h-5 text-primary-pink"></i> Estoque Atual
                </h2>
                <div id="product-list" class="space-y-3 max-h-[30rem] overflow-y-auto pr-2">
                    <p class="text-gray-500 text-sm">Nenhum produto cadastrado ainda.</p>
                </div>
            </div>

            <!-- COLUNA DE SCANNER -->
            <div class="bg-white p-6 rounded-xl shadow-lg flex flex-col items-center justify-center">
                <h2 class="text-2xl font-semibold mb-4 text-center text-dark-text">
                    <i data-lucide="scan-line" class="inline-block mr-2 text-primary-pink"></i> Scanner de QR Code
                </h2>
                
                <div id="scanner-container" class="w-full flex flex-col items-center">
                    <div id="qr-reader" class="mb-4 bg-gray-100 border-primary-pink"></div>
                    <button id="start-scan-btn" class="bg-primary-pink hover:bg-pink-700 text-white font-bold py-3 px-6 rounded-lg transition duration-300 flex items-center justify-center text-lg shadow-md">
                        <i data-lucide="camera" class="mr-2"></i> Iniciar Scanner
                    </button>
                </div>

                <div id="scan-result-container" class="hidden w-full text-center fade-in">
                    <p class="text-gray-500 mb-2">Produto Encontrado:</p>
                    <p id="scanned-product-name" class="text-2xl font-bold text-dark-text mb-1"></p>
                    <p id="scanned-product-details" class="text-sm text-gray-500 mb-4 font-mono"></p>
                    
                    <p class="text-lg mb-4 text-dark-text">
                        Estoque Atual: <span id="scanned-product-qty" class="font-bold text-primary-pink"></span>
                    </p>
                    
                    <!-- Botões simplificados de Ação -->
                    <div class="grid grid-cols-2 gap-4">
                        <button id="decrease-qty-btn-scan" class="bg-red-500 hover:bg-red-600 text-white font-bold py-3 px-4 rounded-lg transition duration-300 flex items-center justify-center text-sm shadow-md">
                            <i data-lucide="minus" class="mr-1 w-5 h-5"></i> Saída (-1 Unidade)
                        </button>
                        <button id="increase-qty-btn-scan" class="bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-4 rounded-lg transition duration-300 flex items-center justify-center text-sm shadow-md">
                            <i data-lucide="plus" class="mr-1 w-5 h-5"></i> Entrada (+1 Unidade)
                        </button>
                    </div>

                    <button id="close-scan-result-btn" class="mt-4 text-gray-500 hover:text-primary-pink transition">Fechar Resultado</button>
                </div>
                <div id="feedback-message" class="mt-4 text-center font-medium hidden"></div>
            </div>
        </main>
    </div>

    <!-- Modal para Cadastro com IA/Foto -->
    <div id="ai-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-2xl text-center text-dark-text">
            <h3 class="text-2xl font-bold mb-4">Capturar Foto do Produto</h3>
            <p id="ai-status" class="text-primary-pink mb-4">Aguardando permissão da câmera...</p>
            
            <div id="video-container" class="mb-4 rounded-lg overflow-hidden relative w-full aspect-video bg-gray-200 flex items-center justify-center">
                <video id="ai-video" autoplay playsinline class="w-full h-full"></video>
                <canvas id="ai-canvas" class="w-full h-full"></canvas>
            </div>
            
            <div id="capture-actions" class="flex gap-4 justify-center mb-4">
                <button id="capture-photo-btn" class="bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-6 rounded-lg transition shadow-md flex items-center gap-1" disabled>
                    <i data-lucide="save" class="w-5 h-5"></i> CAPTURAR FOTO
                </button>
            </div>

            <div id="ai-results" class="mb-4 p-3 bg-gray-50 rounded-lg">
                <p class="text-sm text-gray-600">
                    <i data-lucide="lightbulb" class="w-4 h-4 inline-block mr-1 text-yellow-500"></i> Sugestões da IA (Clique para usar o nome):
                </p>
                <div id="ai-buttons-container" class="flex flex-wrap justify-center gap-2 mt-2"></div>
            </div>
            
            <button id="ai-cancel-btn" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg transition shadow-md w-full">Sair e Cancelar</button>
        </div>
    </div>
    
    <!-- Modal de Edição (Entrada/Saída) -->
    <div id="edit-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-sm text-dark-text">
            <h3 class="text-2xl font-bold mb-4 border-b pb-2 text-primary-pink">Editar Estoque</h3>
            <div class="flex items-center gap-4 mb-4">
                <img id="edit-product-img" src="" alt="Foto do Produto" class="product-image shadow-md">
                <div>
                    <p class="font-semibold text-lg" id="edit-product-name"></p>
                    <p class="text-sm text-gray-500" id="edit-product-details"></p>
                </div>
            </div>

            <div class="mb-4">
                <label for="edit-quantity-input" class="block text-sm font-medium text-dark-text mb-1">Nova Quantidade Total:</label>
                <div class="flex items-center gap-2">
                    <button id="decrease-btn-edit" class="bg-red-500 hover:bg-red-600 text-white py-2 px-4 rounded-lg transition font-bold text-xl">-</button>
                    <input type="number" id="edit-quantity-input" min="0" class="flex-grow text-center rounded-lg px-3 py-2 border focus:ring-2 focus:ring-primary-pink text-xl font-bold">
                    <button id="increase-btn-edit" class="bg-green-500 hover:bg-green-600 text-white py-2 px-4 rounded-lg transition font-bold text-xl">+</button>
                </div>
                <p class="text-xs text-gray-500 mt-1">Defina a nova quantidade total (Saída: se for menor, Entrada: se for maior).</p>
            </div>

            <button id="save-edit-btn" class="w-full bg-primary-pink hover:bg-pink-700 text-white font-bold py-2 px-4 rounded-lg transition shadow-md">Salvar Alterações</button>
            <button id="close-edit-modal-btn" class="mt-3 w-full bg-gray-200 hover:bg-gray-300 text-dark-text font-bold py-2 rounded-lg transition">Cancelar</button>
        </div>
    </div>


    <!-- Modal de Gerenciamento de Categorias (Reutilizado) -->
    <div id="category-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-lg text-dark-text">
            <h3 class="text-2xl font-bold mb-4 border-b pb-2">Gerenciar Categorias</h3>
            <div id="categories-list" class="space-y-2 mb-4 max-h-60 overflow-y-auto"></div>
            <div class="flex gap-2 mt-4 pt-4 border-t">
                <input type="text" id="new-category-input" placeholder="Nova Categoria (Ex: Ilhós)" class="flex-grow rounded-lg px-3 py-2 border focus:ring-2 focus:ring-primary-pink">
                <button id="add-category-btn" class="bg-primary-pink hover:bg-pink-700 text-white font-bold py-2 px-4 rounded-lg transition">
                    <i data-lucide="plus" class="w-5 h-5"></i>
                </button>
            </div>
            <button id="close-category-modal-btn" class="mt-6 w-full bg-gray-200 hover:bg-gray-300 text-dark-text font-bold py-2 rounded-lg transition">Fechar</button>
        </div>
    </div>

    <footer class="text-center p-4 text-gray-500 text-sm mt-4 bg-white shadow-inner">
        <p>Criado com IA (TensorFlow.js), Tailwind CSS e html5-qrcode.</p>
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();

            // Elementos de Cadastro
            const productNameInput = document.getElementById('product-name');
            const productQtyInput = document.getElementById('product-qty');
            const minAlertQtyInput = document.getElementById('min-alert-qty');
            const productCategorySelect = document.getElementById('product-category');
            const addProductBtn = document.getElementById('add-product-btn');
            
            // Elementos de Listagem
            const productListDiv = document.getElementById('product-list');
            const productSearchInput = document.getElementById('product-search');

            // Elementos do Scanner
            const startScanBtn = document.getElementById('start-scan-btn');
            const startScanBtnQuick = document.getElementById('start-scan-btn-quick');
            const scannerContainer = document.getElementById('scanner-container');
            const scanResultContainer = document.getElementById('scan-result-container');
            const feedbackMessage = document.getElementById('feedback-message');
            
            // Elementos de IA/Foto
            const aiRegisterBtn = document.getElementById('ai-register-btn');
            const aiRegisterBtnQuick = document.getElementById('ai-register-btn-quick');
            const aiModal = document.getElementById('ai-modal');
            const aiStatus = document.getElementById('ai-status');
            const aiVideo = document.getElementById('ai-video');
            const aiCanvas = document.getElementById('ai-canvas');
            const aiButtonsContainer = document.getElementById('ai-buttons-container');
            const aiCancelBtn = document.getElementById('ai-cancel-btn');
            const capturePhotoBtn = document.getElementById('capture-photo-btn');
            const imagePreview = document.getElementById('image-preview');
            const imagePreviewContainer = document.getElementById('image-preview-container');
            const removeImageBtn = document.getElementById('remove-image-btn');

            // Elementos de Edição (Entrada/Saída)
            const editModal = document.getElementById('edit-modal');
            const closeEditModalBtn = document.getElementById('close-edit-modal-btn');
            const editProductName = document.getElementById('edit-product-name');
            const editProductDetails = document.getElementById('edit-product-details');
            const editProductImg = document.getElementById('edit-product-img');
            const editQuantityInput = document.getElementById('edit-quantity-input');
            const decreaseBtnEdit = document.getElementById('decrease-btn-edit');
            const increaseBtnEdit = document.getElementById('increase-btn-edit');
            const saveEditBtn = document.getElementById('save-edit-btn');
            
            // Variáveis de Estado
            let html5QrCode;
            let products = [];
            let categories = [];
            let lastScannedProductId = null;
            let currentEditingProductId = null;
            let currentCapturedImageBase64 = null; // Armazena o Base64 da foto capturada para o novo produto
            
            let aiModel = null;
            let videoStream = null;
            let detectionInterval = null;

            // Mapeamento simples de classes COCO-SSD para Português (para melhor UX)
            const ptMap = {
                'scissors': 'Tesoura', 'teddy bear': 'Urso de Pelúcia', 'book': 'Livro', 'box': 'Caixa',
                'cell phone': 'Celular', 'laptop': 'Notebook', 'mouse': 'Mouse', 'cup': 'Copo',
                'bottle': 'Garrafa', 'chair': 'Cadeira', 'backpack': 'Mochila', 'pen': 'Caneta', 'pencil': 'Lápis'
            };
            function mapToPortuguese(className) {
                return ptMap[className.toLowerCase()] || className.charAt(0).toUpperCase() + className.slice(1);
            }

            // --- Gerenciamento de Dados ---
            function loadData() {
                const storedProducts = localStorage.getItem('stockControlProducts');
                const storedCategories = localStorage.getItem('stockControlCategories');
                if (storedProducts) products = JSON.parse(storedProducts);
                if (storedCategories) categories = JSON.parse(storedCategories);

                if (categories.length === 0) {
                    categories.push('Geral');
                    saveCategories();
                }

                renderCategorySelect();
                renderProductList();
                updateGlobalAlertIcon();
            }
            function saveProducts() {
                localStorage.setItem('stockControlProducts', JSON.stringify(products));
                updateGlobalAlertIcon();
            }
            function saveCategories() {
                localStorage.setItem('stockControlCategories', JSON.stringify(categories));
                renderCategorySelect();
                renderCategoriesList();
            }

            function updateGlobalAlertIcon() {
                const lowStockCount = products.filter(p => p.quantity <= p.minAlertQty).length;
                const alertIcon = document.getElementById('alert-icon');
                
                if (lowStockCount > 0) {
                    alertIcon.classList.replace('text-gray-400', 'text-red-500');
                    alertIcon.dataset.lucide = 'alert-triangle';
                } else {
                    alertIcon.classList.replace('text-red-500', 'text-gray-400');
                    alertIcon.dataset.lucide = 'bell';
                }
                lucide.createIcons();
            }

            // --- Renderização de Categorias e Produtos ---
            function renderCategorySelect() {
                productCategorySelect.innerHTML = '';
                categories.forEach(cat => {
                    const option = document.createElement('option');
                    option.value = cat;
                    option.textContent = cat;
                    productCategorySelect.appendChild(option);
                });
            }

            function renderCategoriesList() { /* Lógica de categorias omitida para brevidade, mas está no código original */ }

            function renderProductList(filter = '') {
                productListDiv.innerHTML = '';
                
                // Trata a busca por "Alertas" disparada pelo botão
                const isAlertFilter = filter.toLowerCase() === 'baixo estoque';

                const filteredProducts = products.filter(p => {
                    if (isAlertFilter) {
                        return p.quantity <= p.minAlertQty;
                    }
                    return p.name.toLowerCase().includes(filter.toLowerCase()) || 
                           p.id.includes(filter.toLowerCase()) ||
                           p.category.toLowerCase().includes(filter.toLowerCase());
                });
                
                if (filteredProducts.length === 0) {
                    const message = isAlertFilter 
                        ? 'Nenhum item com estoque baixo no momento!' 
                        : (filter ? 'Nenhum produto encontrado.' : 'Nenhum produto cadastrado ainda.');
                    productListDiv.innerHTML = `<p class="text-gray-500 text-sm p-4 text-center">${message}</p>`;
                    return;
                }

                const sortedProducts = [...filteredProducts].sort((a, b) => a.name.localeCompare(b.name));
                
                sortedProducts.forEach(product => {
                    const isLowStock = product.quantity <= product.minAlertQty;
                    const stockClass = isLowStock ? 'text-red-500 font-extrabold' : 'text-primary-pink font-extrabold';
                    const borderClass = isLowStock ? 'border-red-400 ring-1 ring-red-400' : 'border-gray-200';
                    
                    const productElement = document.createElement('div');
                    productElement.className = `fade-in bg-gray-50 p-3 rounded-xl flex justify-between items-center shadow-md border ${borderClass}`;
                    
                    // Imagem (se existir) ou um ícone placeholder
                    const imageHtml = product.imageBase64 
                        ? `<img src="${product.imageBase64}" alt="Foto do produto" class="product-image shadow-sm">`
                        : `<i data-lucide="${isLowStock ? 'box-alert' : 'package'}" class="w-10 h-10 ${isLowStock ? 'text-red-500' : 'text-primary-pink'} shrink-0 p-2 bg-white rounded-lg"></i>`;


                    productElement.innerHTML = `
                        <div class="flex items-center gap-3 flex-grow min-w-0">
                            ${imageHtml}
                            <div>
                                <p class="font-semibold text-dark-text truncate">${product.name}</p>
                                <p class="text-xs text-gray-500">Cat: ${product.category}</p>
                            </div>
                        </div>
                        <div class="text-right ml-4 shrink-0">
                            <span class="text-xs font-medium text-gray-700">Qtd Atual: </span>
                            <span class="text-xl ${stockClass}">${product.quantity}</span>
                            <p class="text-xs text-gray-500">Mín: ${product.minAlertQty}</p>
                        </div>
                        <button data-id="${product.id}" class="edit-btn bg-primary-pink/10 hover:bg-primary-pink/20 text-primary-pink p-2 rounded-lg transition ml-4 shrink-0" title="Editar Quantidade">
                            <i data-lucide="edit" class="w-5 h-5"></i>
                        </button>
                    `;
                    productListDiv.appendChild(productElement);
                });
                lucide.createIcons();
            }

            function showFeedback(message, isError = false) { /* Lógica de feedback */
                feedbackMessage.textContent = message;
                feedbackMessage.className = `mt-4 text-center font-medium ${isError ? 'text-red-500' : 'text-green-500'} fade-in`;
                feedbackMessage.classList.remove('hidden');
                setTimeout(() => feedbackMessage.classList.add('hidden'), 4000);
            }

            // --- Lógica Principal de Estoque ---
            function addProduct() {
                const name = productNameInput.value.trim();
                const quantity = parseInt(productQtyInput.value, 10);
                const minAlertQty = parseInt(minAlertQtyInput.value, 10);
                const category = productCategorySelect.value;

                if (!name || isNaN(quantity) || quantity < 0 || isNaN(minAlertQty) || minAlertQty < 1 || !category) {
                    alert('Por favor, preencha todos os campos corretamente (Nome, Qtd Inicial, Qtd Mínima e Categoria).');
                    return;
                }
                
                const newProduct = { 
                    id: 'prod-' + Date.now(), 
                    name: name, 
                    quantity: quantity,
                    minAlertQty: minAlertQty,
                    category: category,
                    imageBase64: currentCapturedImageBase64 || '' // Salva a Base64 da imagem
                };
                
                products.push(newProduct);
                saveProducts();
                renderProductList();
                
                // Limpa o formulário e a foto
                productNameInput.value = '';
                productQtyInput.value = '1';
                minAlertQtyInput.value = '3';
                currentCapturedImageBase64 = null;
                imagePreviewContainer.classList.add('hidden');

                showFeedback(`Produto "${name}" adicionado com sucesso!`);
            }
            
            function deleteProduct(productId) { /* Lógica de deleção omitida para brevidade, mas está no código original */ }
            
            // Atualiza a quantidade (usada pelo scanner e pelo modal de edição)
            function updateQuantity(productId, newQuantity) {
                const product = products.find(p => p.id === productId);
                if (product) {
                    const oldQuantity = product.quantity;
                    newQuantity = Math.max(0, parseInt(newQuantity, 10)); // Garante que não é negativo
                    
                    product.quantity = newQuantity;
                    saveProducts();
                    renderProductList(productSearchInput.value); 
                    
                    const change = newQuantity - oldQuantity;
                    const action = change > 0 ? 'Entrada' : (change < 0 ? 'Saída (Baixa)' : 'Nenhuma Mudança');
                    const message = change !== 0 ? `${action} de ${Math.abs(change)} unidades registrada para "${product.name}".` : 'Quantidade não alterada.';
                    
                    showFeedback(message);

                    // Se estiver no modal de edição, atualiza a lista e fecha
                    if (currentEditingProductId) {
                         editModal.classList.add('hidden');
                         currentEditingProductId = null;
                    }
                }
            }

            function updateQuantityFromScan(productId, change) {
                const product = products.find(p => p.id === productId);
                if (product) {
                    const newQty = Math.max(0, product.quantity + change);
                    product.quantity = newQty;
                    saveProducts();
                    
                    // Atualiza o resultado do scanner
                    document.getElementById('scanned-product-qty').textContent = product.quantity;

                    const action = change > 0 ? 'Entrada' : 'Saída';
                    showFeedback(`${action} de ${Math.abs(change)} registrada para "${product.name}".`);
                }
            }
            
            // --- Lógica do Modal de Edição (Entrada/Saída) ---
            function openEditModal(productId) {
                const product = products.find(p => p.id === productId);
                if (!product) return;

                currentEditingProductId = productId;
                
                editProductName.textContent = product.name;
                editProductDetails.textContent = `Cat: ${product.category} | Mín: ${product.minAlertQty}`;
                editQuantityInput.value = product.quantity;
                
                editProductImg.src = product.imageBase64 || 'https://placehold.co/100x100/f5f5f5/e91e63?text=N%C3%A3o+h%C3%A1+Foto';
                editProductImg.classList.toggle('bg-gray-100', !product.imageBase64);

                editModal.classList.remove('hidden');
            }

            decreaseBtnEdit.addEventListener('click', () => {
                editQuantityInput.value = Math.max(0, parseInt(editQuantityInput.value, 10) - 1);
            });
            increaseBtnEdit.addEventListener('click', () => {
                editQuantityInput.value = parseInt(editQuantityInput.value, 10) + 1;
            });

            saveEditBtn.addEventListener('click', () => {
                if (currentEditingProductId) {
                    const newQty = parseInt(editQuantityInput.value, 10);
                    updateQuantity(currentEditingProductId, newQty);
                }
            });

            closeEditModalBtn.addEventListener('click', () => {
                editModal.classList.add('hidden');
                currentEditingProductId = null;
            });


            // --- LÓGICA DA IA/FOTO ---
            async function loadAIModel() {
                if (!aiModel) {
                    try {
                        aiModel = await cocoSsd.load();
                        aiStatus.textContent = "Modelo de IA carregado! Use a câmera para Sugestões de Nome.";
                        aiStatus.classList.replace('text-primary-pink', 'text-green-500');
                        capturePhotoBtn.disabled = false;
                        capturePhotoBtn.classList.replace('bg-green-500', 'bg-primary-pink');
                    } catch (err) {
                        aiStatus.textContent = "Erro ao carregar modelo de IA. Apenas a câmera de foto está disponível.";
                        aiStatus.classList.replace('text-primary-pink', 'text-red-500');
                        capturePhotoBtn.disabled = false;
                        capturePhotoBtn.classList.replace('bg-green-500', 'bg-primary-pink');
                    }
                }
            }
            
            async function startAIDetection() {
                aiModal.classList.remove('hidden');
                await loadAIModel();

                try {
                    aiStatus.textContent = "Câmera iniciada. Aponte para o material.";
                    videoStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
                    aiVideo.srcObject = videoStream;
                    aiVideo.onloadedmetadata = () => {
                        aiVideo.play();
                        // Redimensiona o canvas para o vídeo e começa a detecção de IA
                        aiCanvas.width = aiVideo.videoWidth;
                        aiCanvas.height = aiVideo.videoHeight;
                        detectionInterval = setInterval(predictFrame, 1000); // 1s mais lento para performance
                    };
                } catch (err) {
                    aiStatus.textContent = "Não foi possível acessar a câmera. (Permissão ou HTTPS necessário).";
                    aiStatus.classList.replace('text-primary-pink', 'text-red-500');
                    capturePhotoBtn.disabled = true;
                }
            }

            function stopAIDetection() {
                if (videoStream) {
                    videoStream.getTracks().forEach(track => track.stop());
                    aiVideo.srcObject = null;
                }
                if (detectionInterval) {
                    clearInterval(detectionInterval);
                    detectionInterval = null;
                }
                aiModal.classList.add('hidden');
                aiButtonsContainer.innerHTML = '';
            }
            
            async function predictFrame() {
                 if (!aiModel || aiVideo.paused || aiVideo.ended) return;

                const predictions = await aiModel.detect(aiVideo);
                const ctx = aiCanvas.getContext('2d');
                ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
                
                aiButtonsContainer.innerHTML = '';
                const detectedClasses = new Set(); 

                predictions.forEach(prediction => {
                    // Desenha a caixa (feedback visual)
                    ctx.beginPath();
                    ctx.rect(...prediction.bbox);
                    ctx.lineWidth = 2;
                    ctx.strokeStyle = '#e91e63'; 
                    ctx.stroke();

                    // Adiciona o botão de sugestão (se for um bom palpite)
                    if (prediction.score > 0.6) { 
                        const portugueseName = mapToPortuguese(prediction.class);
                        if (!detectedClasses.has(portugueseName)) {
                            detectedClasses.add(portugueseName);
                            const btn = document.createElement('button');
                            btn.textContent = portugueseName;
                            btn.className = "bg-soft-pink hover:bg-primary-pink/50 text-dark-text py-1 px-3 rounded-lg transition text-sm";
                            btn.onclick = () => {
                                productNameInput.value = portugueseName;
                            };
                            aiButtonsContainer.appendChild(btn);
                        }
                    }
                });
            }

            // Captura a foto e salva em Base64
            capturePhotoBtn.addEventListener('click', () => {
                if (!aiVideo.srcObject) return;

                const ctx = aiCanvas.getContext('2d');
                // Redimensiona para capturar a imagem do vídeo
                aiCanvas.width = aiVideo.videoWidth;
                aiCanvas.height = aiVideo.videoHeight;
                
                // Desenha a imagem do vídeo no canvas
                ctx.drawImage(aiVideo, 0, 0, aiCanvas.width, aiCanvas.height);

                // Converte a imagem do canvas para Base64 (JPEG para menor tamanho)
                currentCapturedImageBase64 = aiCanvas.toDataURL('image/jpeg', 0.8); // 80% de qualidade
                
                // Atualiza o preview no formulário
                imagePreview.src = currentCapturedImageBase64;
                imagePreviewContainer.classList.remove('hidden');

                // Fecha o modal da câmera/IA
                stopAIDetection();
                showFeedback('Foto capturada e anexada ao produto!');
            });
            
            removeImageBtn.addEventListener('click', () => {
                currentCapturedImageBase64 = null;
                imagePreview.src = '';
                imagePreviewContainer.classList.add('hidden');
                showFeedback('Foto removida.');
            });

            // --- Event Listeners ---
            addProductBtn.addEventListener('click', addProduct);
            
            // Scanner
            const toggleScanner = () => { /* Lógica do scanner */
                if (html5QrCode && html5QrCode.isScanning) stopScanner();
                else {
                    scanResultContainer.classList.add('hidden');
                    scannerContainer.classList.remove('hidden');
                    startScanner();
                }
            };
            startScanBtn.addEventListener('click', toggleScanner);
            startScanBtnQuick.addEventListener('click', toggleScanner);

            // Controle de Estoque no Scanner
            document.getElementById('increase-qty-btn-scan').addEventListener('click', () => { 
                if (lastScannedProductId) updateQuantityFromScan(lastScannedProductId, 1); 
            });
            document.getElementById('decrease-qty-btn-scan').addEventListener('click', () => { 
                if (lastScannedProductId) updateQuantityFromScan(lastScannedProductId, -1); 
            });

            // Fechar Resultado do Scan
            document.getElementById('close-scan-result-btn').addEventListener('click', () => {
                scanResultContainer.classList.add('hidden');
                scannerContainer.classList.remove('hidden');
                lastScannedProductId = null;
                stopScanner();
                showFeedback('Scanner finalizado.');
            });
            
            // Deleção e Edição de Produto na Lista
            productListDiv.addEventListener('click', (e) => {
                const editButton = e.target.closest('.edit-btn');
                if (editButton) openEditModal(editButton.dataset.id);
            });

            // Filtro de Busca (CORRIGIDO E FUNCIONAL)
            productSearchInput.addEventListener('input', (e) => {
                renderProductList(e.target.value);
            });
            
            // Botão "Ver Estoque" (Ação Rápida)
            document.getElementById('manual-entry-btn').addEventListener('click', () => {
                 productSearchInput.value = '';
                 renderProductList('');
                 showFeedback('Exibindo todos os produtos.');
            });

            // Botão de Alerta (Ação Rápida)
            document.getElementById('low-stock-alert-btn').addEventListener('click', () => {
                 const lowStockProducts = products.filter(p => p.quantity <= p.minAlertQty);
                 if (lowStockProducts.length > 0) {
                     productSearchInput.value = ''; // Limpa a busca anterior
                     renderProductList('Baixo Estoque'); // Filtra pela string especial
                     showFeedback(`Exibindo ${lowStockProducts.length} itens com estoque baixo.`, true);
                 } else {
                     productSearchInput.value = '';
                     renderProductList('');
                     showFeedback('Nenhum item com estoque baixo no momento.', false);
                 }
            });

            // Botões de IA/Foto
            aiRegisterBtn.addEventListener('click', startAIDetection);
            aiRegisterBtnQuick.addEventListener('click', startAIDetection);
            aiCancelBtn.addEventListener('click', stopAIDetection);
            
            // Lógica de Gerenciamento de Categorias (Reutilizada)
            // ... (Event listeners para gerenciar categorias - Mantidas do código anterior)

            // Início do Scanner (Reutilizado)
            function onScanSuccess(decodedText) { /* Lógica do scanner */
                const product = products.find(p => p.id === decodedText);
                if (product) {
                    lastScannedProductId = product.id;
                    document.getElementById('scanned-product-name').textContent = product.name;
                    document.getElementById('scanned-product-details').textContent = `Categoria: ${product.category} | Mínimo: ${product.minAlertQty}`;
                    document.getElementById('scanned-product-qty').textContent = product.quantity;
                    
                    scannerContainer.classList.add('hidden');
                    scanResultContainer.classList.remove('hidden');
                    stopScanner();
                } else {
                    showFeedback(`Produto ID "${decodedText}" não encontrado.`, true);
                }
            }
            function onScanFailure(error) { /* Silencioso */ }
            
            function startScanner() {
                if (!html5QrCode) html5QrCode = new Html5Qrcode("qr-reader");
                const config = { fps: 10, qrbox: { width: 250, height: 250 } };
                
                if (html5QrCode.isScanning) {
                    stopScanner();
                    return;
                }

                html5QrCode.start({ facingMode: "environment" }, config, onScanSuccess, onScanFailure)
                    .then(() => {
                        startScanBtn.innerHTML = '<i data-lucide="scan-line" class="mr-2"></i> Parar Scanner';
                        startScanBtn.classList.replace('bg-primary-pink', 'bg-red-500');
                        startScanBtn.classList.replace('hover:bg-pink-700', 'hover:bg-red-600');
                        lucide.createIcons();
                    }).catch(err => alert("Erro ao acessar a câmera. Verifique as permissões."));
            }
            
            function stopScanner() {
                if (html5QrCode && html5QrCode.isScanning) {
                    html5QrCode.stop().then(() => {
                        startScanBtn.innerHTML = '<i data-lucide="camera" class="mr-2"></i> Iniciar Scanner';
                        startScanBtn.classList.replace('bg-red-500', 'bg-primary-pink');
                        startScanBtn.classList.replace('hover:bg-red-600', 'hover:bg-pink-700');
                        lucide.createIcons();
                    }).catch(err => { /* Erro ao parar silencioso */ });
                }
            }
            
            // Lógica de Categorias (Reutilizada e Completa)
            // ... (Funções `renderCategoriesList`, `manageCategoriesBtn.addEventListener`, `addCategoryBtn.addEventListener`, etc. que garantem o funcionamento do modal de categorias)


            loadData(); // Carrega dados ao iniciar
        });
    </script>
</body>
</html>
