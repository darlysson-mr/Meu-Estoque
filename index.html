<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Controle de Estoque Pessoal (Estilo App)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary-pink': '#e91e63', // Rosa vibrante (Destaque Méliuz)
                        'soft-pink': '#f8bbd0',
                        'light-bg': '#f5f5f5', // Fundo bem claro
                        'dark-text': '#262626',
                    }
                }
            }
        }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest/dist/tf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd@latest/dist/coco-ssd.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <link rel="icon" href="favicon.png" type="image/png">
    <link rel="apple-touch-icon" href="favicon.png"> 
    <link rel="manifest" href="manifest.json">

    <style>
        html, body { height: 100%; font-family: 'Inter', sans-serif; }
        body { background-color: #f5f5f5; color: #262626; }
        /* Estilos do Scanner QR */
        #qr-reader { width: 100%; max-width: 400px; border-radius: 8px; overflow: hidden; border: 2px solid #e91e63; }
        .fade-in { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        /* Estilos para o modal e inputs */
        #ai-modal, #category-modal { background-color: rgba(0, 0, 0, 0.8); }
        #video-container { position: relative; }
        #ai-canvas { position: absolute; top: 0; left: 0; }
        input:not([type="checkbox"]), select {
            border: 1px solid #e5e7eb !important;
            background-color: white !important;
            color: #262626 !important;
        }
    </style>
</head>
<body class="flex flex-col min-h-screen">
    <div class="container mx-auto p-0 flex-grow">
        
        <header class="bg-white shadow-md mb-4 sticky top-0 z-10">
            <div class="p-4 flex justify-between items-center border-b border-gray-100">
                <h1 class="text-2xl font-bold text-primary-pink">Estoque Pessoal</h1>
                <div class="flex items-center space-x-3 text-dark-text">
                    <i data-lucide="bell" id="alert-icon" class="w-6 h-6 hover:text-primary-pink cursor-pointer text-gray-400"></i>
                    <i data-lucide="settings" class="w-6 h-6 hover:text-primary-pink cursor-pointer"></i>
                </div>
            </div>

            <div class="p-4 bg-light-bg">
                <div class="relative">
                    <input type="text" id="product-search" placeholder="Busque por produtos ou IDs..." class="w-full bg-white border border-gray-200 rounded-lg py-2 pl-10 pr-4 text-dark-text focus:ring-2 focus:ring-primary-pink focus:outline-none transition shadow-inner">
                    <i data-lucide="search" class="w-5 h-5 absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                </div>
            </div>
        </header>

        <main class="grid grid-cols-1 lg:grid-cols-2 gap-6 p-4 md:p-6">
            
            <div class="bg-white p-6 rounded-xl shadow-lg">

                <h2 class="text-xl font-semibold mb-3 border-b border-gray-100 pb-2 text-dark-text flex items-center">
                    <i data-lucide="zap" class="mr-2 text-primary-pink w-5 h-5"></i> Ações Rápidas
                </h2>
                <div class="grid grid-cols-4 gap-4 mb-8 text-center">
                    <button id="ai-register-btn-quick" title="Cadastrar com Foto (IA)" class="flex flex-col items-center p-2 rounded-lg hover:bg-soft-pink/30 transition text-dark-text">
                        <i data-lucide="camera" class="w-7 h-7 text-primary-pink mb-1"></i>
                        <span class="text-xs font-medium">Cad. IA</span>
                    </button>
                    <button id="start-scan-btn-quick" title="Iniciar Scanner" class="flex flex-col items-center p-2 rounded-lg hover:bg-soft-pink/30 transition text-dark-text">
                        <i data-lucide="scan-line" class="w-7 h-7 text-primary-pink mb-1"></i>
                        <span class="text-xs font-medium">Scanner</span>
                    </button>
                    <button id="manual-entry-btn" title="Ver Estoque" class="flex flex-col items-center p-2 rounded-lg hover:bg-soft-pink/30 transition text-dark-text">
                        <i data-lucide="package" class="w-7 h-7 text-primary-pink mb-1"></i>
                        <span class="text-xs font-medium">Ver Estoque</span>
                    </button>
                    <button id="low-stock-alert-btn" title="Estoque Baixo" class="flex flex-col items-center p-2 rounded-lg hover:bg-soft-pink/30 transition text-dark-text">
                        <i data-lucide="alert-triangle" class="w-7 h-7 text-red-500 mb-1"></i>
                        <span class="text-xs font-medium">Alertas</span>
                    </button>
                </div>

                <h2 class="text-xl font-semibold mb-4 border-b border-gray-100 pb-2 text-dark-text flex items-center">
                    <i data-lucide="plus-circle" class="mr-2 w-5 h-5 text-primary-pink"></i> Novo Produto
                </h2>
                <div class="space-y-4">
                    <div>
                        <label for="product-name" class="block text-sm font-medium text-dark-text mb-1">Nome do Produto (Ex: Tassel Vermelho)</label>
                        <div class="flex items-center gap-2">
                            <input type="text" id="product-name" placeholder="Nome + Cor/Variação" class="w-full rounded-lg px-3 py-2 focus:ring-2 focus:ring-primary-pink focus:outline-none transition shadow-sm">
                            <button id="ai-register-btn" title="Cadastrar com Foto (IA)" class="bg-gray-200 hover:bg-gray-300 p-2 rounded-lg transition text-dark-text">
                                <i data-lucide="camera" class="w-5 h-5"></i>
                            </button>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label for="product-qty" class="block text-sm font-medium text-dark-text mb-1">Qtd. Inicial (Unidades)</label>
                            <input type="number" id="product-qty" value="1" min="0" class="w-full rounded-lg px-3 py-2 focus:ring-2 focus:ring-primary-pink focus:outline-none transition shadow-sm">
                        </div>
                        <div>
                            <label for="min-alert-qty" class="block text-sm font-medium text-dark-text mb-1">Qtd. Mínima p/ Alerta</label>
                            <input type="number" id="min-alert-qty" value="3" min="1" class="w-full rounded-lg px-3 py-2 focus:ring-2 focus:ring-primary-pink focus:outline-none transition shadow-sm">
                        </div>
                    </div>

                    <div>
                         <label for="product-category" class="block text-sm font-medium text-dark-text mb-1">Categoria</label>
                         <div class="flex gap-2">
                             <select id="product-category" class="w-full rounded-lg px-3 py-2 focus:ring-2 focus:ring-primary-pink focus:outline-none transition shadow-sm"></select>
                             <button id="manage-categories-btn" title="Gerenciar Categorias" class="bg-gray-200 hover:bg-gray-300 p-2 rounded-lg transition text-dark-text">
                                <i data-lucide="settings-2" class="w-5 h-5"></i>
                            </button>
                         </div>
                    </div>
                    
                    <button id="add-product-btn" class="w-full bg-primary-pink hover:bg-pink-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300 flex items-center justify-center shadow-lg">
                        <i data-lucide="plus-circle" class="mr-2"></i> Adicionar Produto
                    </button>
                </div>

                <h2 class="text-xl font-semibold mt-8 mb-4 border-b border-gray-100 pb-2 text-dark-text flex items-center">
                    <i data-lucide="list" class="mr-2 w-5 h-5 text-primary-pink"></i> Estoque Atual
                </h2>
                <div id="product-list" class="space-y-3 max-h-96 overflow-y-auto pr-2">
                    <p class="text-gray-500 text-sm">Nenhum produto cadastrado ainda.</p>
                </div>
            </div>

            <div class="bg-white p-6 rounded-xl shadow-lg flex flex-col items-center justify-center">
                <h2 class="text-2xl font-semibold mb-4 text-center text-dark-text">
                    <i data-lucide="scan-line" class="inline-block mr-2 text-primary-pink"></i> Scanner de QR Code
                </h2>
                
                <div id="scanner-container" class="w-full flex flex-col items-center">
                    <div id="qr-reader" class="mb-4 bg-gray-100 border-primary-pink"></div>
                    <button id="start-scan-btn" class="bg-primary-pink hover:bg-pink-700 text-white font-bold py-3 px-6 rounded-lg transition duration-300 flex items-center justify-center text-lg shadow-md">
                        <i data-lucide="camera" class="mr-2"></i> Iniciar Scanner
                    </button>
                </div>

                <div id="scan-result-container" class="hidden w-full text-center fade-in">
                    <p class="text-gray-500 mb-2">Produto Encontrado:</p>
                    <p id="scanned-product-name" class="text-2xl font-bold text-dark-text mb-1"></p>
                    <p id="scanned-product-details" class="text-sm text-gray-500 mb-4 font-mono"></p>
                    
                    <p class="text-lg mb-4 text-dark-text">
                        Estoque Atual: <span id="scanned-product-qty" class="font-bold text-primary-pink"></span>
                    </p>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <button id="decrease-qty-btn" class="bg-red-500 hover:bg-red-600 text-white font-bold py-3 px-4 rounded-lg transition duration-300 flex items-center justify-center text-sm shadow-md">
                            <i data-lucide="minus" class="mr-1 w-5 h-5"></i> Saída (-1 Unidade)
                        </button>
                        <button id="increase-qty-btn" class="bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-4 rounded-lg transition duration-300 flex items-center justify-center text-sm shadow-md">
                            <i data-lucide="plus" class="mr-1 w-5 h-5"></i> Entrada (+1 Unidade)
                        </button>
                    </div>

                    <button id="close-scan-result-btn" class="mt-4 text-gray-500 hover:text-primary-pink transition">Fechar</button>
                </div>
                <div id="feedback-message" class="mt-4 text-center font-medium hidden"></div>
            </div>
        </main>
    </div>

    <div id="ai-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-2xl text-center text-dark-text">
            <h3 class="text-2xl font-bold mb-4">Cadastro por Imagem (IA)</h3>
            <p id="ai-status" class="text-primary-pink mb-4">Carregando modelo de IA... Por favor, aguarde.</p>
            <div id="video-container" class="mb-4 rounded-lg overflow-hidden relative w-full aspect-video bg-gray-200 flex items-center justify-center">
                <video id="ai-video" autoplay playsinline class="w-full h-full"></video>
                <canvas id="ai-canvas" class="w-full h-full"></canvas>
            </div>
            <div id="ai-results" class="mb-4">
                <p class="text-gray-600">Aponte a câmera para um objeto. Clique no nome sugerido para selecioná-lo e finalize o cadastro:</p>
                <div id="ai-buttons-container" class="flex flex-wrap justify-center gap-2 mt-2"></div>
            </div>
            <button id="ai-cancel-btn" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg transition shadow-md">Cancelar</button>
        </div>
    </div>

    <div id="category-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-lg text-dark-text">
            <h3 class="text-2xl font-bold mb-4 border-b pb-2">Gerenciar Categorias</h3>
            
            <div id="categories-list" class="space-y-2 mb-4 max-h-60 overflow-y-auto">
                </div>

            <div class="flex gap-2 mt-4 pt-4 border-t">
                <input type="text" id="new-category-input" placeholder="Nova Categoria (Ex: Ilhós)" class="flex-grow rounded-lg px-3 py-2 border focus:ring-2 focus:ring-primary-pink">
                <button id="add-category-btn" class="bg-primary-pink hover:bg-pink-700 text-white font-bold py-2 px-4 rounded-lg transition">
                    <i data-lucide="plus" class="w-5 h-5"></i>
                </button>
            </div>
            
            <button id="close-category-modal-btn" class="mt-6 w-full bg-gray-200 hover:bg-gray-300 text-dark-text font-bold py-2 rounded-lg transition">Fechar</button>
        </div>
    </div>

    <footer class="text-center p-4 text-gray-500 text-sm mt-4 bg-white shadow-inner">
        <p>Criado com IA (TensorFlow.js), Tailwind CSS e html5-qrcode.</p>
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();

            // Elementos de Cadastro
            const productNameInput = document.getElementById('product-name');
            const productQtyInput = document.getElementById('product-qty');
            const minAlertQtyInput = document.getElementById('min-alert-qty');
            const productCategorySelect = document.getElementById('product-category');
            const addProductBtn = document.getElementById('add-product-btn');
            
            // Elementos de Listagem
            const productListDiv = document.getElementById('product-list');
            const productSearchInput = document.getElementById('product-search');

            // Elementos do Scanner
            const startScanBtn = document.getElementById('start-scan-btn');
            const startScanBtnQuick = document.getElementById('start-scan-btn-quick');
            const scannerContainer = document.getElementById('scanner-container');
            const scanResultContainer = document.getElementById('scan-result-container');
            const feedbackMessage = document.getElementById('feedback-message');
            
            // Elementos de IA
            const aiRegisterBtn = document.getElementById('ai-register-btn');
            const aiRegisterBtnQuick = document.getElementById('ai-register-btn-quick');
            const aiModal = document.getElementById('ai-modal');
            const aiStatus = document.getElementById('ai-status');
            const aiVideo = document.getElementById('ai-video');
            const aiCanvas = document.getElementById('ai-canvas');
            const aiButtonsContainer = document.getElementById('ai-buttons-container');
            const aiCancelBtn = document.getElementById('ai-cancel-btn');

            // Elementos de Categoria
            const manageCategoriesBtn = document.getElementById('manage-categories-btn');
            const categoryModal = document.getElementById('category-modal');
            const closeCategoryModalBtn = document.getElementById('close-category-modal-btn');
            const newCategoryInput = document.getElementById('new-category-input');
            const addCategoryBtn = document.getElementById('add-category-btn');
            const categoriesListDiv = document.getElementById('categories-list');

            let html5QrCode;
            let products = [];
            let categories = [];
            let lastScannedProductId = null;

            let aiModel = null;
            let videoStream = null;
            let detectionInterval = null;

            // Mapeamento simples de classes COCO-SSD para Português (para melhor UX)
            const ptMap = {
                'person': 'Pessoa', 'bicycle': 'Bicicleta', 'car': 'Carro', 'motorcycle': 'Moto', 'airplane': 'Avião',
                'bus': 'Ônibus', 'train': 'Trem', 'truck': 'Caminhão', 'boat': 'Barco', 'traffic light': 'Semáforo',
                'fire hydrant': 'Hidrante', 'stop sign': 'Placa de Pare', 'parking meter': 'Parquímetro', 'bench': 'Banco',
                'bird': 'Pássaro', 'cat': 'Gato', 'dog': 'Cachorro', 'horse': 'Cavalo', 'sheep': 'Ovelha', 'cow': 'Vaca',
                'elephant': 'Elefante', 'bear': 'Urso', 'zebra': 'Zebra', 'giraffe': 'Girafa', 'backpack': 'Mochila',
                'umbrella': 'Guarda-chuva', 'handbag': 'Bolsa', 'tie': 'Gravata', 'suitcase': 'Mala', 'frisbee': 'Frisbee',
                'skis': 'Esquis', 'snowboard': 'Snowboard', 'sports ball': 'Bola Esportiva', 'kite': 'Pipa', 'baseball bat': 'Bastão',
                'baseball glove': 'Luva de Baseball', 'skateboard': 'Skate', 'surfboard': 'Prancha de Surf', 'tennis racket': 'Raquete',
                'bottle': 'Garrafa', 'wine glass': 'Taça de Vinho', 'cup': 'Copo', 'fork': 'Garfo', 'knife': 'Faca', 'spoon': 'Colher',
                'bowl': 'Tigela', 'banana': 'Banana', 'apple': 'Maçã', 'sandwich': 'Sanduíche', 'orange': 'Laranja', 'broccoli': 'Brócolis',
                'carrot': 'Cenoura', 'hot dog': 'Cachorro-quente', 'pizza': 'Pizza', 'donut': 'Donut', 'cake': 'Bolo', 'chair': 'Cadeira',
                'couch': 'Sofá', 'potted plant': 'Planta em Vaso', 'bed': 'Cama', 'dining table': 'Mesa de Jantar', 'toilet': 'Vaso Sanitário',
                'tv': 'TV', 'laptop': 'Notebook', 'mouse': 'Mouse', 'remote': 'Controle Remoto', 'keyboard': 'Teclado',
                'cell phone': 'Celular', 'microwave': 'Micro-ondas', 'oven': 'Forno', 'toaster': 'Torradeira', 'sink': 'Pia',
                'refrigerator': 'Geladeira', 'book': 'Livro', 'clock': 'Relógio', 'vase': 'Vaso', 'scissors': 'Tesoura',
                'teddy bear': 'Urso de Pelúcia', 'hair drier': 'Secador de Cabelo', 'toothbrush': 'Escova de Dentes',
                'pen': 'Caneta', 'pencil': 'Lápis', 'eraser': 'Borracha', 'paper': 'Papel', 'box': 'Caixa' 
            };
            function mapToPortuguese(className) {
                return ptMap[className.toLowerCase()] || className.charAt(0).toUpperCase() + className.slice(1);
            }

            // --- Gerenciamento de Dados ---
            function loadData() {
                const storedProducts = localStorage.getItem('stockControlProducts');
                const storedCategories = localStorage.getItem('stockControlCategories');
                if (storedProducts) products = JSON.parse(storedProducts);
                if (storedCategories) categories = JSON.parse(storedCategories);

                // Garante que a categoria "Geral" exista se estiver vazio
                if (categories.length === 0) {
                    categories.push('Geral');
                    saveCategories();
                }

                renderCategorySelect();
                renderProductList();
                updateGlobalAlertIcon();
            }
            function saveProducts() {
                localStorage.setItem('stockControlProducts', JSON.stringify(products));
                updateGlobalAlertIcon();
            }
            function saveCategories() {
                localStorage.setItem('stockControlCategories', JSON.stringify(categories));
                renderCategorySelect();
                renderCategoriesList();
            }

            function updateGlobalAlertIcon() {
                const lowStockCount = products.filter(p => p.quantity <= p.minAlertQty).length;
                const alertIcon = document.getElementById('alert-icon');
                
                if (lowStockCount > 0) {
                    alertIcon.classList.replace('text-gray-400', 'text-red-500');
                    alertIcon.dataset.lucide = 'alert-triangle';
                } else {
                    alertIcon.classList.replace('text-red-500', 'text-gray-400');
                    alertIcon.dataset.lucide = 'bell';
                }
                lucide.createIcons();
            }

            // --- Renderização de Categorias ---
            function renderCategorySelect() {
                productCategorySelect.innerHTML = '';
                categories.forEach(cat => {
                    const option = document.createElement('option');
                    option.value = cat;
                    option.textContent = cat;
                    productCategorySelect.appendChild(option);
                });
            }

            function renderCategoriesList() {
                categoriesListDiv.innerHTML = '';
                if (categories.length === 0) {
                    categoriesListDiv.innerHTML = '<p class="text-gray-500 text-sm">Nenhuma categoria cadastrada.</p>';
                    return;
                }

                categories.forEach(cat => {
                    const catElement = document.createElement('div');
                    catElement.className = 'flex justify-between items-center p-2 bg-gray-100 rounded-lg';
                    catElement.innerHTML = `
                        <span>${cat}</span>
                        ${cat !== 'Geral' ? `<button data-category="${cat}" class="delete-category-btn text-gray-400 hover:text-red-500 transition"><i data-lucide="trash-2" class="w-5 h-5"></i></button>` : `<span class="text-xs text-gray-400">Padrão</span>`}
                    `;
                    categoriesListDiv.appendChild(catElement);
                });
                lucide.createIcons();
            }

            // --- Renderização de Produtos (Cartões e Alertas) ---
            function renderProductList(filter = '') {
                productListDiv.innerHTML = '';
                const filteredProducts = products.filter(p => 
                    p.name.toLowerCase().includes(filter.toLowerCase()) || 
                    p.id.includes(filter.toLowerCase()) ||
                    p.category.toLowerCase().includes(filter.toLowerCase())
                );
                
                if (filteredProducts.length === 0) {
                    productListDiv.innerHTML = `<p class="text-gray-500 text-sm">${filter ? 'Nenhum produto encontrado.' : 'Nenhum produto cadastrado ainda.'}</p>`;
                    return;
                }

                const sortedProducts = [...filteredProducts].sort((a, b) => a.name.localeCompare(b.name));
                
                sortedProducts.forEach(product => {
                    const isLowStock = product.quantity <= product.minAlertQty;
                    const stockClass = isLowStock ? 'text-red-500 font-extrabold' : 'text-primary-pink font-extrabold';
                    const borderClass = isLowStock ? 'border-red-400 ring-1 ring-red-400' : 'border-gray-200';
                    
                    const productElement = document.createElement('div');
                    productElement.className = `fade-in bg-gray-50 p-4 rounded-lg flex justify-between items-center shadow-md border ${borderClass}`;
                    
                    productElement.innerHTML = `
                        <div class="flex items-center gap-3">
                            <i data-lucide="${isLowStock ? 'box-alert' : 'package'}" class="w-6 h-6 ${isLowStock ? 'text-red-500' : 'text-primary-pink'} shrink-0"></i>
                            <div>
                                <p class="font-semibold text-dark-text">${product.name}</p>
                                <p class="text-xs text-gray-500">Cat: ${product.category}</p>
                            </div>
                        </div>
                        <div class="text-right ml-4">
                            <span class="text-xs font-medium text-gray-700">Qtd Atual: </span>
                            <span class="text-xl ${stockClass}">${product.quantity}</span>
                            <p class="text-xs text-gray-500">Mínimo: ${product.minAlertQty}</p>
                        </div>
                        <button data-id="${product.id}" class="delete-btn text-gray-400 hover:text-red-500 transition ml-4 shrink-0">
                            <i data-lucide="trash-2" class="w-5 h-5"></i>
                        </button>
                    `;
                    productListDiv.appendChild(productElement);
                });
                lucide.createIcons();
            }

            function showFeedback(message, isError = false) {
                feedbackMessage.textContent = message;
                feedbackMessage.className = `mt-4 text-center font-medium ${isError ? 'text-red-500' : 'text-green-500'} fade-in`;
                feedbackMessage.classList.remove('hidden');
                setTimeout(() => feedbackMessage.classList.add('hidden'), 4000);
            }

            // --- Lógica Principal de Estoque ---
            function addProduct() {
                const name = productNameInput.value.trim();
                const quantity = parseInt(productQtyInput.value, 10);
                const minAlertQty = parseInt(minAlertQtyInput.value, 10);
                const category = productCategorySelect.value;

                if (!name || isNaN(quantity) || quantity < 0 || isNaN(minAlertQty) || minAlertQty < 1 || !category) {
                    alert('Por favor, preencha o nome, quantidade inicial, quantidade mínima para alerta e selecione uma categoria.');
                    return;
                }
                
                const newProduct = { 
                    id: 'prod-' + Date.now(), 
                    name: name, 
                    quantity: quantity,
                    minAlertQty: minAlertQty,
                    category: category
                };
                
                products.push(newProduct);
                saveProducts();
                renderProductList();
                
                // Limpa o formulário
                productNameInput.value = '';
                productQtyInput.value = '1';
                minAlertQtyInput.value = '3';
                
                showFeedback(`Produto "${name}" adicionado com sucesso na categoria "${category}"!`);
            }
            
            function deleteProduct(productId) {
                if (confirm('Tem certeza que deseja excluir este produto?')) {
                    products = products.filter(p => p.id !== productId);
                    saveProducts();
                    renderProductList();
                    showFeedback('Produto excluído.');
                }
            }
            
            // Lógica simplificada de atualização (+1 ou -1 unidade)
            function updateQuantity(productId, change) {
                const product = products.find(p => p.id === productId);
                if (product) {
                    product.quantity = Math.max(0, product.quantity + change);
                    
                    saveProducts();
                    renderProductList(productSearchInput.value); 
                    
                    // Atualiza a visualização do scanner
                    document.getElementById('scanned-product-qty').textContent = product.quantity;

                    const action = change > 0 ? 'Entrada' : 'Saída';
                    showFeedback(`${action} de ${Math.abs(change)} registrada para "${product.name}".`);
                }
            }
            
            // --- Lógica do Scanner de QR Code ---
            function onScanSuccess(decodedText) {
                const product = products.find(p => p.id === decodedText);
                if (product) {
                    lastScannedProductId = product.id;
                    document.getElementById('scanned-product-name').textContent = product.name;
                    document.getElementById('scanned-product-details').textContent = `Categoria: ${product.category} | Mínimo: ${product.minAlertQty}`;
                    
                    // Atualiza a exibição de estoque
                    document.getElementById('scanned-product-qty').textContent = product.quantity;
                    
                    scannerContainer.classList.add('hidden');
                    scanResultContainer.classList.remove('hidden');
                    stopScanner();
                } else {
                    showFeedback(`Produto com QR Code ID "${decodedText}" não encontrado.`, true);
                }
            }
            function onScanFailure(error) { /* Silencioso */ }
            
            function startScanner() {
                if (!html5QrCode) html5QrCode = new Html5Qrcode("qr-reader");
                const config = { fps: 10, qrbox: { width: 250, height: 250 } };
                
                if (html5QrCode.isScanning) {
                    stopScanner();
                    return;
                }

                html5QrCode.start({ facingMode: "environment" }, config, onScanSuccess, onScanFailure)
                    .then(() => {
                        startScanBtn.innerHTML = '<i data-lucide="scan-line" class="mr-2"></i> Parar Scanner';
                        startScanBtn.classList.replace('bg-primary-pink', 'bg-red-500');
                        startScanBtn.classList.replace('hover:bg-pink-700', 'hover:bg-red-600');
                        lucide.createIcons();
                    }).catch(err => alert("Erro ao acessar a câmera. Verifique as permissões (e certifique-se de estar em HTTPS/localhost)."));
            }
            
            function stopScanner() {
                if (html5QrCode && html5QrCode.isScanning) {
                    html5QrCode.stop().then(() => {
                        startScanBtn.innerHTML = '<i data-lucide="camera" class="mr-2"></i> Iniciar Scanner';
                        startScanBtn.classList.replace('bg-red-500', 'bg-primary-pink');
                        startScanBtn.classList.replace('hover:bg-red-600', 'hover:bg-pink-700');
                        lucide.createIcons();
                    }).catch(err => { /* Erro ao parar silencioso */ });
                }
            }
            
            // --- LÓGICA DA IA (COCO-SSD) ---
            async function loadAIModel() {
                if (!aiModel) {
                    try {
                        aiModel = await cocoSsd.load();
                        aiStatus.textContent = "Modelo carregado! Aponte para o material.";
                        aiStatus.classList.replace('text-primary-pink', 'text-green-500');
                    } catch (err) {
                        console.error("Erro ao carregar modelo de IA:", err);
                        aiStatus.textContent = "Erro ao carregar modelo.";
                        aiStatus.classList.replace('text-primary-pink', 'text-red-500');
                    }
                }
            }
            
            async function startAIDetection() {
                aiModal.classList.remove('hidden');
                await loadAIModel();

                try {
                    videoStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
                    aiVideo.srcObject = videoStream;
                    aiVideo.onloadedmetadata = () => {
                        aiVideo.play();
                        // Ajusta a detecção para ser um pouco mais lenta
                        detectionInterval = setInterval(predictFrame, 500); 
                    };
                } catch (err) {
                    console.error("Erro ao acessar a câmera para IA:", err);
                    aiStatus.textContent = "Não foi possível acessar a câmera. Verifique as permissões.";
                    aiStatus.classList.replace('text-primary-pink', 'text-red-500');
                }
            }

            function stopAIDetection() {
                if (videoStream) {
                    videoStream.getTracks().forEach(track => track.stop());
                }
                if (detectionInterval) {
                    clearInterval(detectionInterval);
                    detectionInterval = null;
                }
                aiModal.classList.add('hidden');
                aiButtonsContainer.innerHTML = '';
            }

            async function predictFrame() {
                if (!aiModel || aiVideo.paused || aiVideo.ended) return;

                const predictions = await aiModel.detect(aiVideo);
                
                // Redimensiona o canvas para o vídeo (apenas uma vez)
                if (aiCanvas.width === 0) {
                    aiCanvas.width = aiVideo.videoWidth;
                    aiCanvas.height = aiVideo.videoHeight;
                }

                const ctx = aiCanvas.getContext('2d');
                ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
                
                aiButtonsContainer.innerHTML = '';
                const detectedClasses = new Set(); 

                predictions.forEach(prediction => {
                    const portugueseName = mapToPortuguese(prediction.class);

                    // Desenha a caixa (mantido para visualização)
                    ctx.beginPath();
                    ctx.rect(...prediction.bbox);
                    ctx.lineWidth = 2;
                    ctx.strokeStyle = '#e91e63'; 
                    ctx.stroke();

                    // Adiciona o botão de sugestão
                    if (!detectedClasses.has(portugueseName)) {
                        detectedClasses.add(portugueseName);
                        const btn = document.createElement('button');
                        btn.textContent = `Sugestão: ${portugueseName}`;
                        btn.className = "bg-primary-pink hover:bg-pink-700 text-white font-bold py-2 px-4 rounded-lg transition shadow-md text-sm";
                        btn.onclick = () => {
                            productNameInput.value = portugueseName;
                            stopAIDetection();
                        };
                        aiButtonsContainer.appendChild(btn);
                    }
                });
            }


            // --- Event Listeners ---
            addProductBtn.addEventListener('click', addProduct);
            
            // Scanner
            const toggleScanner = () => {
                if (html5QrCode && html5QrCode.isScanning) stopScanner();
                else {
                    scanResultContainer.classList.add('hidden');
                    scannerContainer.classList.remove('hidden');
                    startScanner();
                }
            };
            startScanBtn.addEventListener('click', toggleScanner);
            startScanBtnQuick.addEventListener('click', toggleScanner);

            // Controle de Estoque na Leitura de QR
            document.getElementById('increase-qty-btn').addEventListener('click', () => { 
                if (lastScannedProductId) updateQuantity(lastScannedProductId, 1); 
            });
            document.getElementById('decrease-qty-btn').addEventListener('click', () => { 
                if (lastScannedProductId) updateQuantity(lastScannedProductId, -1); 
            });

            // Fechar Resultado do Scan
            document.getElementById('close-scan-result-btn').addEventListener('click', () => {
                scanResultContainer.classList.add('hidden');
                scannerContainer.classList.remove('hidden');
                lastScannedProductId = null;
                stopScanner();
            });
            
            // Deleção de Produto
            productListDiv.addEventListener('click', (e) => {
                const deleteButton = e.target.closest('.delete-btn');
                if (deleteButton) deleteProduct(deleteButton.dataset.id);
            });

            // Filtro de Busca
            productSearchInput.addEventListener('input', (e) => {
                renderProductList(e.target.value);
            });
            
            // Botão de Alerta
            document.getElementById('low-stock-alert-btn').addEventListener('click', () => {
                 const lowStockProducts = products.filter(p => p.quantity <= p.minAlertQty);
                 if (lowStockProducts.length > 0) {
                     renderProductList('Baixo Estoque'); 
                     showFeedback(`Exibindo ${lowStockProducts.length} itens com estoque baixo.`);
                 } else {
                     showFeedback('Nenhum item com estoque baixo.', false);
                     renderProductList('');
                 }
            });

            // Botões de IA
            aiRegisterBtn.addEventListener('click', startAIDetection);
            aiRegisterBtnQuick.addEventListener('click', startAIDetection);
            aiCancelBtn.addEventListener('click', stopAIDetection);
            
            // --- Lógica de Gerenciamento de Categorias ---
            manageCategoriesBtn.addEventListener('click', () => {
                renderCategoriesList();
                categoryModal.classList.remove('hidden');
            });
            closeCategoryModalBtn.addEventListener('click', () => {
                categoryModal.classList.add('hidden');
            });

            addCategoryBtn.addEventListener('click', () => {
                const newCat = newCategoryInput.value.trim();
                if (newCat && !categories.includes(newCat)) {
                    categories.push(newCat);
                    saveCategories();
                    newCategoryInput.value = '';
                } else if (newCat) {
                     alert('Categoria já existe!');
                }
            });

            categoriesListDiv.addEventListener('click', (e) => {
                const deleteButton = e.target.closest('.delete-category-btn');
                if (deleteButton) {
                    const catToDelete = deleteButton.dataset.category;
                    if (confirm(`Tem certeza que deseja excluir a categoria "${catToDelete}"? Produtos nela serão movidos para "Geral".`)) {
                        // Move produtos para a categoria "Geral"
                        products.forEach(p => {
                            if (p.category === catToDelete) p.category = 'Geral';
                        });
                        saveProducts();

                        // Remove a categoria
                        categories = categories.filter(cat => cat !== catToDelete);
                        saveCategories();
                        renderCategoriesList();
                    }
                }
            });


            loadData();
        });
    </script>
</body>
</html>
