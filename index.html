<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Estoque Pessoal - Controle com Scanner</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Configuração de cores do Tailwind para Pink/Magenta e fontes -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        'primary-pink': '#e91e63', // Rosa vibrante
                        'soft-pink': '#f8bbd0',
                        'light-bg': '#f5f5f5',
                        'dark-text': '#262626',
                    }
                }
            }
        }
    </script>
    <!-- Bibliotecas de IA (TensorFlow.js e COCO-SSD) -->
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest/dist/tf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd@latest/dist/coco-ssd.min.js"></script>
    <!-- Biblioteca para leitura de QR Code -->
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <!-- Ícones (Lucide) -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <style>
        /* Estilo para ocultar o input de arquivo e garantir responsividade */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border-width: 0;
        }
        /* Estilo para a área do scanner */
        #scanner-container {
            width: 100%;
            height: 300px;
            overflow: hidden;
            border-radius: 0.5rem;
            background-color: #333;
        }
    </style>
</head>
<body class="bg-light-bg font-sans text-dark-text">

    <header class="bg-primary-pink p-4 shadow-xl">
        <div class="flex justify-between items-center max-w-7xl mx-auto">
            <h1 class="text-3xl font-extrabold text-white tracking-wider">
                Controle de Estoque
            </h1>
            <div id="user-display" class="text-xs text-white p-2 border border-soft-pink rounded-lg bg-primary-pink/20">
                Carregando...
            </div>
        </div>
    </header>

    <main class="max-w-7xl mx-auto p-4 sm:p-6 lg:p-8">
        
        <!-- Seção de Ações Principais -->
        <div class="bg-white p-4 rounded-xl shadow-lg mb-6">
            <h2 class="text-xl font-bold mb-4">Ferramentas</h2>
            <div class="flex flex-col sm:flex-row gap-4">
                
                <!-- Botão Novo Produto -->
                <button
                    id="new-product-btn"
                    class="flex-1 px-4 py-3 bg-green-600 text-white font-bold rounded-lg shadow-md hover:bg-green-700 transition duration-300 flex items-center justify-center"
                >
                    <i data-lucide="package-plus" class="mr-2 h-5 w-5"></i> Novo Produto
                </button>

                <!-- Botão Scanner -->
                <button
                    id="start-scan-btn"
                    class="flex-1 px-4 py-3 bg-primary-pink text-white font-bold rounded-lg shadow-md hover:bg-pink-700 transition duration-300 flex items-center justify-center"
                >
                    <i data-lucide="camera" class="mr-2 h-5 w-5"></i> Iniciar Scanner
                </button>
            </div>
        </div>

        <!-- Seção do Scanner -->
        <div id="scanner-section" class="bg-white p-4 rounded-xl shadow-lg mb-6 hidden">
            <h2 class="text-xl font-bold mb-4">Scanner de Código (QR/EAN)</h2>
            <div id="scanner-container"></div>
            <p id="scan-result" class="mt-4 text-center text-gray-700 font-semibold"></p>
        </div>

        <!-- Seção de Visão Computacional -->
        <div id="vision-section" class="bg-white p-4 rounded-xl shadow-lg mb-6">
            <h2 class="text-xl font-bold mb-4">Análise de Imagem (IA)</h2>
            <div class="relative mb-4">
                <video id="webcam-video" class="w-full h-auto rounded-lg border border-gray-300" autoplay playsinline muted></video>
                <canvas id="prediction-canvas" class="absolute inset-0 w-full h-full"></canvas>
            </div>
            <p id="vision-status" class="text-center text-sm text-gray-500">A carregar modelo COCO-SSD...</p>
        </div>

        <!-- Lista de Produtos -->
        <h2 id="stock-title" class="text-2xl font-semibold text-gray-900 mb-4">Estoque</h2>
        <div id="product-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            <div class="text-center py-10 bg-white rounded-xl shadow-md col-span-full">
                <p class="text-gray-500">A carregar produtos...</p>
            </div>
        </div>
    </main>

    <!-- Modal de Edição/Criação -->
    <div id="edit-modal-backdrop" class="fixed inset-0 bg-gray-900 bg-opacity-75 hidden items-center justify-center p-4 z-50 overflow-y-auto">
        <div id="edit-modal" class="bg-white rounded-xl shadow-2xl w-full max-w-lg transition-all transform duration-300">
            <div class="p-6 border-b border-gray-200 bg-primary-pink rounded-t-xl">
                <h3 id="modal-title" class="text-2xl font-bold text-white">Novo Produto</h3>
            </div>
            <form id="product-form" class="p-6 space-y-4">
                <!-- SEÇÃO DA IMAGEM E CÓDIGO -->
                <div class="space-y-4 p-4 bg-gray-50 rounded-lg border">
                    <label class="block text-sm font-medium text-gray-700">Foto do Produto</label>
                    <div class="flex items-center space-x-4">
                        <div class="w-24 h-24 flex-shrink-0 bg-gray-200 rounded-lg overflow-hidden border border-gray-300">
                            <img id="current-image" src="https://placehold.co/96x96/e91e63/ffffff?text=?" alt="Pré-visualização" class="w-full h-full object-cover"/>
                        </div>
                        <div class="flex-grow">
                            <label 
                                for="file-upload" 
                                id="file-label"
                                class="cursor-pointer inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-indigo-600 hover:bg-indigo-700 focus-within:outline-none focus-within:ring-2 focus-within:ring-offset-2 focus-within:ring-indigo-500 transition"
                            >
                                <i data-lucide="image" class="mr-2 h-4 w-4"></i> Selecionar Arquivo
                            </label>
                            <input id="file-upload" type="file" accept="image/*" class="sr-only"/>
                            <p id="file-status" class="mt-1 text-sm text-gray-500">Nenhum ficheiro selecionado.</p>
                        </div>
                    </div>
                    <div>
                        <label for="codigo" class="block text-sm font-medium text-gray-700">Código de Barras/QR</label>
                        <input id="codigo" type="text" placeholder="Escaneie ou digite o código" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2"/>
                    </div>
                </div>
                <!-- FIM SEÇÃO DA IMAGEM E CÓDIGO -->

                <div>
                    <label for="nome" class="block text-sm font-medium text-gray-700">Nome do Produto*</label>
                    <input id="nome" type="text" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2"/>
                </div>

                <div>
                    <label for="quantidade" class="block text-sm font-medium text-gray-700">Quantidade*</label>
                    <input id="quantidade" type="number" step="1" min="0" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2"/>
                </div>

                <div>
                    <label for="preco" class="block text-sm font-medium text-gray-700">Preço (R$)</label>
                    <input id="preco" type="number" step="0.01" min="0" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2"/>
                </div>
                
                <div>
                    <label for="descricao" class="block text-sm font-medium text-gray-700">Descrição</label>
                    <textarea id="descricao" rows="3" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 resize-none"></textarea>
                </div>

                <div class="flex justify-end space-x-3 pt-4">
                    <button type="button" id="cancel-btn" class="px-4 py-2 border border-gray-300 rounded-lg shadow-sm text-sm font-medium text-gray-700 hover:bg-gray-50 transition">
                        Cancelar
                    </button>
                    <button type="submit" id="save-btn" class="px-4 py-2 border border-transparent rounded-lg shadow-sm text-sm font-medium text-white bg-primary-pink hover:bg-pink-700 transition">
                        Salvar Produto
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Script de Inicialização e Lógica (Módulo JS Puro) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, deleteDoc, onSnapshot, collection, query, updateDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- VARIÁVEIS GLOBAIS DE AMBIENTE ---
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        // --- VARIÁVEIS DE ESTADO ---
        let db;
        let auth;
        let userId = null;
        let currentEditingProduct = null;
        let fileToUpload = null;
        let currentObjectURL = null; // Para cleanup da URL de pré-visualização
        let html5QrCode = null; // Instância do scanner
        let visionModel = null; // Modelo de IA
        let isScannerRunning = false;

        // --- REFERÊNCIAS DOM ---
        const productList = document.getElementById('product-list');
        const modalBackdrop = document.getElementById('edit-modal-backdrop');
        const productForm = document.getElementById('product-form');
        const fileInput = document.getElementById('file-upload');
        const fileLabel = document.getElementById('file-label');
        const fileStatus = document.getElementById('file-status');
        const currentImage = document.getElementById('current-image');
        const modalTitle = document.getElementById('modal-title');
        const saveBtn = document.getElementById('save-btn');
        const userDisplay = document.getElementById('user-display');
        const stockTitle = document.getElementById('stock-title');
        const startScanBtn = document.getElementById('start-scan-btn');
        const scannerSection = document.getElementById('scanner-section');
        const scanResultText = document.getElementById('scan-result');
        const videoElement = document.getElementById('webcam-video');
        const canvasElement = document.getElementById('prediction-canvas');
        const visionStatus = document.getElementById('vision-status');
        
        // Inputs específicos do produto
        const inputCodigo = document.getElementById('codigo');
        const inputQuantidade = document.getElementById('quantidade');
        const inputPreco = document.getElementById('preco');


        // --- UTILS & MOCK ---

        // Mock de função de upload (simula o upload e retorna um URL)
        const mockUploadImage = (file) => {
            return new Promise((resolve) => {
                setTimeout(() => {
                    console.log(`Simulando upload do arquivo: ${file.name}`);
                    const placeholderText = encodeURIComponent(file.name.substring(0, 10) || 'Produto');
                    // Usando uma cor que combine com a nova paleta
                    resolve(`https://placehold.co/400x300/f8bbd0/e91e63?text=${placeholderText}`);
                }, 1000);
            });
        };

        // Função para limpar o Object URL temporário
        const cleanupObjectURL = () => {
            if (currentObjectURL) {
                URL.revokeObjectURL(currentObjectURL);
                currentObjectURL = null;
            }
        };
        
        // Função simples para mostrar feedback ao usuário
        const showFeedback = (message, isError = false) => {
            scanResultText.textContent = message;
            scanResultText.className = `mt-4 text-center font-semibold ${isError ? 'text-red-600' : 'text-green-600'}`;
        };


        // --- FIREBASE INIT & AUTH ---

        const initFirebase = async () => {
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                    } else {
                        if (initialAuthToken) {
                            const userCredential = await signInWithCustomToken(auth, initialAuthToken);
                            userId = userCredential.user.uid;
                        } else {
                            const userCredential = await signInAnonymously(auth);
                            userId = userCredential.user.uid;
                        }
                    }
                    userDisplay.innerHTML = `Usuário: <span class="font-mono text-white break-all">${userId}</span>`;
                    startListeningToProducts();
                    loadVisionModel(); // Inicia o carregamento do modelo de IA
                });
            } catch (e) {
                console.error("Erro ao inicializar Firebase:", e);
                userDisplay.textContent = "Erro de autenticação";
            }
            lucide.createIcons(); // Carrega ícones Lucide
        };

        // --- RENDERIZAÇÃO DOM ---

        const renderProducts = (products) => {
            productList.innerHTML = '';
            stockTitle.textContent = `Estoque (${products.length})`;
            
            if (products.length === 0) {
                productList.innerHTML = `
                    <div class="text-center py-10 bg-white rounded-xl shadow-md col-span-full">
                        <p class="text-gray-500">Nenhum produto cadastrado ainda. Comece a adicionar!</p>
                    </div>
                `;
                return;
            }

            products.forEach(product => {
                const productCard = document.createElement('div');
                productCard.className = "bg-white rounded-xl shadow-lg overflow-hidden transition duration-300 hover:shadow-xl flex flex-col";
                productCard.innerHTML = `
                    <div class="relative h-48 bg-gray-200">
                        <img 
                            src="${product.imageUrl || "https://placehold.co/400x300/f8bbd0/e91e63?text=SEM+FOTO"}" 
                            alt="Imagem de ${product.nome}" 
                            class="w-full h-full object-cover"
                            onerror="this.onerror=null;this.src='https://placehold.co/400x300/f8bbd0/e91e63?text=ERRO';"
                        />
                        ${product.codigo ? `<span class="absolute top-2 left-2 px-3 py-1 text-xs font-bold text-white bg-primary-pink rounded-full">${product.codigo}</span>` : ''}
                    </div>
                    <div class="p-4 flex flex-col flex-grow">
                        <h3 class="text-xl font-bold text-gray-900 mb-2 truncate">${product.nome}</h3>
                        <p class="text-lg font-extrabold text-green-700 mb-3">
                            Qtd: ${product.quantidade}
                        </p>
                        ${product.preco ? `<p class="text-sm text-gray-500 mb-1">R$ ${parseFloat(product.preco).toFixed(2).replace('.', ',')}</p>` : ''}
                        <p class="text-sm text-gray-600 flex-grow mb-4 line-clamp-2">${product.descricao || 'Sem descrição.'}</p>
                        <div class="flex justify-end space-x-2 mt-auto">
                            <button data-id="${product.id}" class="edit-btn flex-1 py-2 bg-yellow-500 text-white font-semibold rounded-lg hover:bg-yellow-600 transition duration-200 text-sm">
                                <i data-lucide="pencil" class="h-4 w-4 inline mr-1"></i> Editar
                            </button>
                            <button data-id="${product.id}" class="delete-btn flex-1 py-2 bg-red-600 text-white font-semibold rounded-lg hover:bg-red-700 transition duration-200 text-sm">
                                <i data-lucide="trash-2" class="h-4 w-4 inline mr-1"></i> Deletar
                            </button>
                        </div>
                    </div>
                `;
                productList.appendChild(productCard);
                lucide.createIcons(); // Recarrega ícones após adicionar HTML
            });

            // Adicionar Listeners aos botões de Edição e Deleção
            document.querySelectorAll('.edit-btn').forEach(btn => btn.addEventListener('click', (e) => openModal(e.target.dataset.id)));
            document.querySelectorAll('.delete-btn').forEach(btn => btn.addEventListener('click', (e) => deleteProduct(e.target.dataset.id)));
        };

        // --- LÓGICA DO MODAL ---

        const openModal = async (productId = null, initialCode = '') => {
            cleanupObjectURL(); 
            fileToUpload = null;
            productForm.reset(); 
            
            // Limpa o estado da imagem para o placeholder padrão
            currentImage.src = "https://placehold.co/96x96/e91e63/ffffff?text=?"
            fileStatus.textContent = 'Nenhum ficheiro selecionado.';
            fileLabel.textContent = 'Selecionar Arquivo';
            inputCodigo.value = initialCode; // Define código inicial

            if (productId) {
                // Modo Edição
                const productsPath = `/artifacts/${appId}/users/${userId}/products`;
                const productRef = doc(db, productsPath, productId);
                
                try {
                    const docSnap = await getDoc(productRef);
                    if (!docSnap.exists()) {
                        console.error("Produto não encontrado.");
                        return;
                    }

                    const productData = docSnap.data();
                    currentEditingProduct = { id: productId, ...productData };
                    
                    modalTitle.textContent = 'Editar Produto';
                    saveBtn.textContent = 'Salvar Alterações';
                    
                    // Preencher Formulário
                    document.getElementById('nome').value = productData.nome || '';
                    document.getElementById('descricao').value = productData.descricao || '';
                    inputCodigo.value = productData.codigo || initialCode;
                    inputQuantidade.value = productData.quantidade || 0;
                    inputPreco.value = productData.preco ? parseFloat(productData.preco).toFixed(2) : '';
                    
                    // Configurar Imagem
                    const imgUrl = productData.imageUrl || "https://placehold.co/96x96/e91e63/ffffff?text=SEM+FOTO";
                    currentImage.src = imgUrl;
                    fileStatus.textContent = productData.imageUrl ? 'Foto atual carregada.' : 'Nenhum ficheiro selecionado.';
                    fileLabel.textContent = productData.imageUrl ? 'Alterar Foto' : 'Adicionar Foto';

                } catch (error) {
                    console.error("Erro ao buscar produto para edição:", error);
                    return;
                }

            } else {
                // Modo Criação
                currentEditingProduct = { id: null, nome: '', descricao: '', preco: 0.0, quantidade: 0, codigo: initialCode, imageUrl: '' };
                modalTitle.textContent = 'Novo Produto';
                saveBtn.textContent = 'Cadastrar Produto';
                inputQuantidade.value = 1;
            }

            modalBackdrop.style.display = 'flex';
            // Recarrega ícones dentro do modal
            lucide.createIcons(); 
        };

        const closeModal = () => {
            modalBackdrop.style.display = 'none';
            cleanupObjectURL();
            fileToUpload = null;
            currentEditingProduct = null;
        };

        // --- FIREBASE OPERAÇÕES ---

        const startListeningToProducts = () => {
            if (!db || !userId) return;

            const productsPath = `/artifacts/${appId}/users/${userId}/products`;
            const q = query(collection(db, productsPath));

            onSnapshot(q, (snapshot) => {
                const productsData = [];
                snapshot.forEach((doc) => {
                    productsData.push({ id: doc.id, ...doc.data() });
                });
                renderProducts(productsData.sort((a, b) => a.nome.localeCompare(b.nome)));
            }, (error) => {
                console.error("Erro ao carregar produtos:", error);
            });
        };

        const saveProduct = async (e) => {
            e.preventDefault();

            const loadingOverlay = createLoadingOverlay();
            document.body.appendChild(loadingOverlay);

            const nome = document.getElementById('nome').value.trim();
            const descricao = document.getElementById('descricao').value.trim();
            const codigo = inputCodigo.value.trim();
            const quantidade = parseInt(inputQuantidade.value) || 0;
            const preco = parseFloat(inputPreco.value) || 0.0;
            let updatedImageUrl = currentEditingProduct.imageUrl || '';

            // 1. Lidar com o Upload da Imagem, se um novo ficheiro foi selecionado
            if (fileToUpload) {
                try {
                    // Usamos o mock, mas aqui seria o upload real para o Firebase Storage
                    updatedImageUrl = await mockUploadImage(fileToUpload); 
                } catch (error) {
                    console.error("Erro no upload da imagem:", error);
                    showFeedback("Erro ao enviar imagem. Tente novamente.", true);
                    loadingOverlay.remove();
                    return;
                }
            }

            // 2. Preparar dados
            const productDataToSave = {
                nome: nome,
                descricao: descricao,
                codigo: codigo,
                quantidade: quantidade,
                preco: preco,
                imageUrl: updatedImageUrl,
                updatedAt: new Date(),
            };

            const productsPath = `/artifacts/${appId}/users/${userId}/products`;

            try {
                if (currentEditingProduct.id) {
                    // ATUALIZAÇÃO
                    const productRef = doc(db, productsPath, currentEditingProduct.id);
                    await updateDoc(productRef, productDataToSave);
                    console.log("Produto atualizado com sucesso!");
                } else {
                    // CRIAÇÃO
                    const newProductRef = doc(collection(db, productsPath));
                    await setDoc(newProductRef, { 
                        ...productDataToSave, 
                        createdAt: new Date() 
                    });
                    console.log("Produto criado com sucesso!");
                }

                closeModal();
            } catch (error) {
                console.error("Erro ao salvar o produto:", error);
            } finally {
                loadingOverlay.remove();
            }
        };

        const deleteProduct = async (id) => {
            // Usando um modal simples para confirmação
            if (!confirm("Tem certeza que deseja deletar este produto?")) return; 

            const productsPath = `/artifacts/${appId}/users/${userId}/products`;
            const productRef = doc(db, productsPath, id);
            
            try {
                await deleteDoc(productRef);
                console.log(`Produto ${id} deletado.`);
            } catch (error) {
                console.error("Erro ao deletar produto:", error);
            }
        };
        
        // --- LÓGICA DO SCANNER ---

        function onScanSuccess(decodedText, decodedResult) {
            stopScanner();
            showFeedback(`Código escaneado: ${decodedText}`);
            // Abre o modal de produto e preenche o código
            openModal(null, decodedText); 
        }

        function onScanFailure(error) {
            // console.warn(`Code scan error = ${error}`);
            showFeedback("Aguardando código...", false);
        }

        function toggleScanner() {
            if (isScannerRunning) {
                stopScanner();
            } else {
                startScanner();
            }
        }

        function startScanner() {
            if (!html5QrCode) {
                html5QrCode = new Html5Qrcode("scanner-container");
            }
            
            scannerSection.classList.remove('hidden');
            startScanBtn.innerHTML = '<i data-lucide="scan-line" class="mr-2 h-5 w-5"></i> Parar Scanner';
            startScanBtn.classList.replace('bg-primary-pink', 'bg-red-500');
            startScanBtn.classList.replace('hover:bg-pink-700', 'hover:bg-red-600');
            lucide.createIcons();

            html5QrCode.start(
                { facingMode: "environment" }, // Preferir a câmera traseira
                { fps: 10, qrbox: { width: 250, height: 250 } },
                onScanSuccess, onScanFailure
            )
            .then(() => {
                isScannerRunning = true;
            }).catch(err => { 
                showFeedback("Erro ao acessar a câmera. Verifique as permissões.", true);
                stopScanner(); // Parar se houver erro
            });
        }
        
        function stopScanner() {
            if (html5QrCode && html5QrCode.isScanning) {
                html5QrCode.stop().then(() => {
                    isScannerRunning = false;
                    scannerSection.classList.add('hidden');
                    startScanBtn.innerHTML = '<i data-lucide="camera" class="mr-2 h-5 w-5"></i> Iniciar Scanner';
                    startScanBtn.classList.replace('bg-red-500', 'bg-primary-pink');
                    startScanBtn.classList.replace('hover:bg-red-600', 'hover:bg-pink-700');
                    lucide.createIcons();
                }).catch(err => { 
                    isScannerRunning = false;
                    // Erro ao parar silencioso
                });
            } else {
                isScannerRunning = false;
                scannerSection.classList.add('hidden');
                startScanBtn.innerHTML = '<i data-lucide="camera" class="mr-2 h-5 w-5"></i> Iniciar Scanner';
                startScanBtn.classList.replace('bg-red-500', 'bg-primary-pink');
                startScanBtn.classList.replace('hover:bg-red-600', 'hover:bg-pink-700');
                lucide.createIcons();
            }
        }
        
        // --- LÓGICA DA VISÃO COMPUTACIONAL (IA) ---

        async function loadVisionModel() {
            visionStatus.textContent = 'Carregando modelo de IA (COCO-SSD)...';
            try {
                visionModel = await cocoSsd.load();
                visionStatus.textContent = 'Modelo de IA pronto. Iniciando webcam...';
                startWebcamForVision();
            } catch (error) {
                visionStatus.textContent = 'Erro ao carregar o modelo de IA.';
                console.error("Erro ao carregar modelo COCO-SSD:", error);
            }
        }

        function startWebcamForVision() {
            if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } })
                    .then(stream => {
                        videoElement.srcObject = stream;
                        videoElement.onloadedmetadata = () => {
                            videoElement.play();
                            visionStatus.textContent = 'Webcam ativa. A procurar objetos...';
                            requestAnimationFrame(detectFrame);
                        };
                    })
                    .catch(err => {
                        visionStatus.textContent = 'Não foi possível acessar a câmera para IA.';
                        console.error("Erro ao acessar a câmera para IA:", err);
                    });
            } else {
                visionStatus.textContent = 'O seu navegador não suporta MediaDevices.';
            }
        }

        const detectFrame = async () => {
            if (visionModel && videoElement.readyState === 4) {
                const predictions = await visionModel.detect(videoElement);
                renderPredictions(predictions);
            }
            requestAnimationFrame(detectFrame);
        };

        function renderPredictions(predictions) {
            const ctx = canvasElement.getContext('2d');
            const videoRatio = videoElement.videoWidth / videoElement.videoHeight;
            const displayWidth = videoElement.clientWidth;
            const displayHeight = displayWidth / videoRatio;

            // Ajusta o tamanho do canvas para o vídeo
            canvasElement.width = displayWidth;
            canvasElement.height = displayHeight;
            videoElement.style.height = `${displayHeight}px`; // Ajusta o elemento de vídeo

            ctx.clearRect(0, 0, displayWidth, displayHeight);
            ctx.font = '16px Inter';
            ctx.lineWidth = 2;
            
            let detectedItems = [];

            predictions.forEach(prediction => {
                const [x, y, width, height] = prediction.bbox;
                
                // Mapeamento das coordenadas do modelo para o display
                const x_mapped = x * (displayWidth / videoElement.videoWidth);
                const y_mapped = y * (displayHeight / videoElement.videoHeight);
                const width_mapped = width * (displayWidth / videoElement.videoWidth);
                const height_mapped = height * (displayHeight / videoElement.videoHeight);

                // Desenha a caixa
                ctx.strokeStyle = '#e91e63';
                ctx.strokeRect(x_mapped, y_mapped, width_mapped, height_mapped);
                
                // Desenha o rótulo
                const label = `${prediction.class} (${Math.round(prediction.score * 100)}%)`;
                ctx.fillStyle = '#e91e63';
                ctx.fillRect(x_mapped, y_mapped > 16 ? y_mapped - 16 : y_mapped, ctx.measureText(label).width + 8, 16);
                ctx.fillStyle = 'white';
                ctx.fillText(label, x_mapped + 4, y_mapped > 16 ? y_mapped - 3 : y_mapped + 13);
                
                detectedItems.push(prediction.class);
            });
            
            if (detectedItems.length > 0) {
                 visionStatus.textContent = `Itens detetados: ${detectedItems.join(', ')}.`;
            } else {
                 visionStatus.textContent = 'A procurar objetos...';
            }
        }


        // --- LISTENERS E INICIALIZAÇÃO ---

        productForm.addEventListener('submit', saveProduct);
        document.getElementById('new-product-btn').addEventListener('click', () => {
            stopScanner(); // Parar o scanner se estiver ativo ao abrir o modal
            openModal(null);
        });
        document.getElementById('cancel-btn').addEventListener('click', closeModal);
        startScanBtn.addEventListener('click', toggleScanner);

        fileInput.addEventListener('change', (e) => {
            fileToUpload = e.target.files[0];
            cleanupObjectURL();
            
            if (fileToUpload) {
                fileStatus.textContent = `Novo ficheiro selecionado: ${fileToUpload.name}`;
                fileLabel.innerHTML = `<i data-lucide="image" class="mr-2 h-4 w-4"></i> Alterar Foto`;
                // Pré-visualização local
                currentObjectURL = URL.createObjectURL(fileToUpload);
                currentImage.src = currentObjectURL;
            } else {
                // Se o utilizador limpar a seleção, volta à foto existente ou ao placeholder
                fileStatus.textContent = currentEditingProduct?.imageUrl ? 'Foto atual carregada.' : 'Nenhum ficheiro selecionado.';
                fileLabel.innerHTML = currentEditingProduct?.imageUrl ? `<i data-lucide="image" class="mr-2 h-4 w-4"></i> Alterar Foto` : `<i data-lucide="image" class="mr-2 h-4 w-4"></i> Adicionar Foto`;
                currentImage.src = currentEditingProduct?.imageUrl || "https://placehold.co/96x96/e91e63/ffffff?text=?";
            }
            lucide.createIcons();
        });

        // Listener de clique no backdrop para fechar o modal
        modalBackdrop.addEventListener('click', (e) => {
            if (e.target.id === 'edit-modal-backdrop') {
                closeModal();
            }
        });

        // --- COMPONENTE DE CARREGAMENTO SIMPLES (Nativo JS) ---

        function createLoadingOverlay() {
            const div = document.createElement('div');
            div.className = 'fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50';
            div.innerHTML = `
                <div class="flex flex-col items-center p-6 bg-white rounded-lg shadow-xl">
                    <svg class="animate-spin -ml-1 mr-3 h-8 w-8 text-primary-pink" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    <p class="mt-3 text-gray-700 font-medium">Processando...</p>
                </div>
            `;
            return div;
        }

        // --- INICIALIZAÇÃO PRINCIPAL ---
        window.addEventListener('load', initFirebase);
    </script>
</body>
</html>
