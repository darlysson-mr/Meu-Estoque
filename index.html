<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Estoque Pessoal - Controle com Scanner</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary-pink': '#e91e63', // Rosa vibrante
                        'soft-pink': '#f8bbd0',
                        'light-bg': '#f5f5f5', // Fundo bem claro
                        'dark-text': '#262626',
                    }
                }
            }
        }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest/dist/tf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd@latest/dist/coco-ssd.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        /* Estilos adicionais */
        .product-image {
            object-fit: cover;
            border-radius: 8px;
        }
    </style>
</head>
<body class="bg-light-bg min-h-screen font-sans">

    <main class="max-w-4xl mx-auto p-4 md:p-8">
        <h1 class="text-3xl font-bold text-primary-pink mb-6 flex items-center">
            <i data-lucide="package-open" class="mr-3 w-8 h-8"></i>
            Estoque Pessoal
        </h1>

        <div id="product-list" class="bg-white shadow-lg rounded-xl p-4 md:p-6 mb-8">
            <h2 class="text-xl font-semibold text-dark-text mb-4">Produtos Cadastrados</h2>
            <table class="min-w-full divide-y divide-gray-200">
                <thead>
                    </thead>
                <tbody id="product-table-body" class="divide-y divide-gray-200">
                    </tbody>
            </table>
        </div>
        
        </main>
    
    <div id="edit-modal" class="fixed inset-0 bg-gray-600 bg-opacity-75 hidden items-center justify-center p-4 z-50">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-md p-6">
            <h2 class="text-2xl font-bold text-dark-text mb-4 border-b pb-2">Editar Produto</h2>
            <form id="edit-product-form">
                
                <div class="mb-4">
                    <label class="block text-sm font-medium text-dark-text mb-1">Foto do Produto</label>
                    <div class="flex items-center gap-4 p-3 border border-gray-200 rounded-lg bg-light-bg">
                        <img id="edit-product-image-preview" src="" alt="Preview" class="product-image w-20 h-20 shadow-md border border-gray-300">
                        
                        <div class="flex flex-col">
                            <button type="button" id="change-image-btn" class="bg-primary-pink text-white text-sm px-3 py-2 rounded-lg hover:bg-pink-700 transition font-medium flex items-center gap-1 mb-2">
                                <i data-lucide="camera" class="w-4 h-4"></i> Mudar / Anexar Foto
                            </button>
                            
                            <button type="button" id="remove-edit-image-btn" class="text-xs text-red-500 hover:text-red-700 transition underline">
                                Remover Foto
                            </button>
                        </div>
                    </div>
                </div>
                <div class="mb-4">
                    <label for="edit-name" class="block text-sm font-medium text-dark-text mb-1">Nome</label>
                    <input type="text" id="edit-name" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-primary-pink focus:border-primary-pink" required>
                </div>
                <div class="mb-4">
                    <label for="edit-quantity" class="block text-sm font-medium text-dark-text mb-1">Quantidade</label>
                    <input type="number" id="edit-quantity" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-primary-pink focus:border-primary-pink" required min="0">
                </div>
                <div class="mb-4">
                    <label for="edit-barcode" class="block text-sm font-medium text-dark-text mb-1">Código de Barras</label>
                    <input type="text" id="edit-barcode" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-primary-pink focus:border-primary-pink">
                </div>

                <div class="flex justify-end space-x-3 mt-6">
                    <button type="button" id="close-edit-modal-btn" class="px-4 py-2 bg-gray-200 text-dark-text rounded-lg hover:bg-gray-300 transition">Cancelar</button>
                    <button type="submit" class="px-4 py-2 bg-primary-pink text-white rounded-lg hover:bg-pink-700 transition font-medium">Salvar Edição</button>
                </div>
            </form>
        </div>
    </div>
    
    <input type="file" id="edit-image-file-input" accept="image/*" capture="environment" style="display: none;">


    <script>
        // ... (Seu código JavaScript existente) ...

        // Define a URL do placeholder para produtos sem imagem
        // É um GIF 1x1 transparente minimalista para evitar ícone de "imagem quebrada"
        const PLACEHOLDER_IMG_SRC = 'data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7';

        // =======================================================
        // NOVAS FUNÇÕES: Troca e Anexo de Foto no Modal de Edição
        // =======================================================

        const editImageFileInput = document.getElementById('edit-image-file-input');
        const changeImageBtn = document.getElementById('change-image-btn');
        const removeEditImageBtn = document.getElementById('remove-edit-image-btn');
        const editProductImagePreview = document.getElementById('edit-product-image-preview');

        // Variável para armazenar a nova imagem Base64 (ou a imagem atual do produto)
        let currentEditImageBase64 = null;
        let editingProductId = null; // ID do produto que está sendo editado

        // 1. Aciona o campo de arquivo oculto ao clicar no botão
        if (changeImageBtn) {
            changeImageBtn.addEventListener('click', () => {
                editImageFileInput.click();
            });
        }

        // 2. Lida com a seleção/captura da nova imagem
        if (editImageFileInput) {
            editImageFileInput.addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        // Salva a imagem como Base64
                        currentEditImageBase64 = e.target.result;
                        // Atualiza o preview no modal de edição
                        editProductImagePreview.src = currentEditImageBase64;
                        // Limpa o input file para que o evento 'change' dispare novamente se a mesma foto for escolhida
                        editImageFileInput.value = '';
                        showFeedback("Nova foto selecionada. Lembre de Salvar.", false);
                    };
                    reader.readAsDataURL(file);
                }
            });
        }

        // 3. Remove a imagem
        if (removeEditImageBtn) {
            removeEditImageBtn.addEventListener('click', () => {
                currentEditImageBase64 = PLACEHOLDER_IMG_SRC;
                // Define o preview para o placeholder
                editProductImagePreview.src = PLACEHOLDER_IMG_SRC;
                showFeedback("Foto removida. Salve para confirmar.", false);
            });
        }

        // =======================================================
        // INTEGRAÇÃO COM AS FUNÇÕES EXISTENTES
        // (Ajuste o seu código original nestas funções conforme o exemplo abaixo)
        // =======================================================

        // Exemplo da sua função para abrir o modal de edição (Você deve adaptar!)
        function openEditModal(productId) {
            editingProductId = productId;
            const products = JSON.parse(localStorage.getItem('products')) || [];
            const product = products.find(p => p.id === productId);

            if (product) {
                document.getElementById('edit-name').value = product.name;
                document.getElementById('edit-quantity').value = product.quantity;
                document.getElementById('edit-barcode').value = product.barcode || '';
                
                // NOVO: Carregar a foto existente e setar a variável de controle
                currentEditImageBase64 = product.image || PLACEHOLDER_IMG_SRC;
                editProductImagePreview.src = currentEditImageBase64;

                document.getElementById('edit-modal').classList.remove('hidden');
                document.getElementById('edit-modal').classList.add('flex');
            } else {
                showFeedback("Produto não encontrado.", true);
            }
        }
        window.editProduct = openEditModal; // Mantém a função acessível se for chamada do HTML

        // Exemplo da sua função para salvar a edição (Você deve adaptar!)
        document.getElementById('edit-product-form').addEventListener('submit', function(e) {
            e.preventDefault();
            saveEdit();
        });

        function saveEdit() {
            if (!editingProductId) return;

            const newName = document.getElementById('edit-name').value;
            const newQuantity = parseInt(document.getElementById('edit-quantity').value);
            const newBarcode = document.getElementById('edit-barcode').value;

            let products = JSON.parse(localStorage.getItem('products')) || [];
            const productIndex = products.findIndex(p => p.id === editingProductId);

            if (productIndex !== -1) {
                products[productIndex].name = newName;
                products[productIndex].quantity = newQuantity;
                products[productIndex].barcode = newBarcode;
                // NOVO: Salva a nova imagem Base64
                products[productIndex].image = currentEditImageBase64 === PLACEHOLDER_IMG_SRC ? null : currentEditImageBase64;
                
                localStorage.setItem('products', JSON.stringify(products));
                showFeedback("Produto atualizado com sucesso!", false);
                closeEditModal();
                loadData(); // Recarrega a lista
            } else {
                showFeedback("Erro ao salvar: Produto não encontrado.", true);
            }
        }

        function closeEditModal() {
            document.getElementById('edit-modal').classList.remove('flex');
            document.getElementById('edit-modal').classList.add('hidden');
            editingProductId = null;
            currentEditImageBase64 = null;
        }

        // Adiciona o listener para o botão de fechar modal
        document.getElementById('close-edit-modal-btn').addEventListener('click', closeEditModal);

        // Seu restante do código JS (loadData, showFeedback, onScanSuccess, etc.) aqui...
        function loadData() {
            // ... (sua lógica para carregar e renderizar a tabela) ...
        }
        function showFeedback(message, isError) {
            // ... (sua lógica de feedback) ...
            console.log(message);
        }
        // ... (demais funções) ...

        lucide.createIcons();
        loadData(); // Carrega dados ao iniciar
    </script>
</body>
</html>
