<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerenciador de Produtos Estável</title>
    <!-- Carrega Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Configuração de fontes Tailwind -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <style>
        /* Estilo para ocultar o input de arquivo */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border-width: 0;
        }
    </style>
</head>
<body class="bg-gray-100 font-sans">

    <header class="bg-gray-800 p-4 shadow-lg">
        <div class="flex justify-between items-center max-w-7xl mx-auto">
            <h1 class="text-3xl font-extrabold text-white tracking-wider">
                Gerenciador de Produtos
            </h1>
            <div id="user-display" class="text-sm text-gray-400 p-2 border border-gray-600 rounded-lg">
                Carregando utilizador...
            </div>
        </div>
    </header>

    <main class="max-w-7xl mx-auto p-4 sm:p-6 lg:p-8">
        <div class="flex justify-between items-center mb-6">
            <h2 id="stock-title" class="text-2xl font-semibold text-gray-900">Estoque</h2>
            <button
                id="new-product-btn"
                class="px-6 py-2 bg-green-600 text-white font-bold rounded-lg shadow-lg hover:bg-green-700 transition duration-300"
            >
                + Novo Produto
            </button>
        </div>

        <div id="product-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            <div class="text-center py-10 bg-white rounded-xl shadow-md col-span-full">
                <p class="text-gray-500">A carregar produtos...</p>
            </div>
        </div>
    </main>

    <!-- Modal de Edição/Criação -->
    <div id="edit-modal-backdrop" class="fixed inset-0 bg-gray-900 bg-opacity-75 hidden items-center justify-center p-4 z-50 overflow-y-auto">
        <div id="edit-modal" class="bg-white rounded-xl shadow-2xl w-full max-w-lg transition-all transform duration-300">
            <div class="p-6 border-b">
                <h3 id="modal-title" class="text-2xl font-bold text-gray-800">Novo Produto</h3>
            </div>
            <form id="product-form" class="p-6 space-y-4">
                <!-- SEÇÃO DA IMAGEM -->
                <div class="space-y-3 p-4 bg-gray-50 rounded-lg border">
                    <label class="block text-sm font-medium text-gray-700">Foto do Produto</label>
                    <div class="flex items-center space-x-4">
                        <div class="w-24 h-24 flex-shrink-0 bg-gray-200 rounded-lg overflow-hidden border border-gray-300">
                            <img id="current-image" src="https://placehold.co/96x96/e5e7eb/4b5563?text=?" alt="Pré-visualização" class="w-full h-full object-cover"/>
                        </div>
                        <div class="flex-grow">
                            <label 
                                for="file-upload" 
                                id="file-label"
                                class="cursor-pointer inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-indigo-600 hover:bg-indigo-700 focus-within:outline-none focus-within:ring-2 focus-within:ring-offset-2 focus-within:ring-indigo-500 transition"
                            >
                                Selecionar Arquivo
                            </label>
                            <input id="file-upload" type="file" accept="image/*" class="sr-only"/>
                            <p id="file-status" class="mt-1 text-sm text-gray-500">Nenhum ficheiro selecionado.</p>
                        </div>
                    </div>
                </div>
                <!-- FIM SEÇÃO DA IMAGEM -->

                <div>
                    <label for="nome" class="block text-sm font-medium text-gray-700">Nome do Produto*</label>
                    <input id="nome" type="text" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2"/>
                </div>

                <div>
                    <label for="preco" class="block text-sm font-medium text-gray-700">Preço (R$)*</label>
                    <input id="preco" type="number" step="0.01" min="0" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2"/>
                </div>
                
                <div>
                    <label for="descricao" class="block text-sm font-medium text-gray-700">Descrição</label>
                    <textarea id="descricao" rows="3" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 resize-none"></textarea>
                </div>

                <div class="flex justify-end space-x-3 pt-4">
                    <button type="button" id="cancel-btn" class="px-4 py-2 border border-gray-300 rounded-lg shadow-sm text-sm font-medium text-gray-700 hover:bg-gray-50 transition">
                        Cancelar
                    </button>
                    <button type="submit" id="save-btn" class="px-4 py-2 border border-transparent rounded-lg shadow-sm text-sm font-medium text-white bg-green-600 hover:bg-green-700 transition">
                        Cadastrar Produto
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Script de Inicialização e Lógica (Módulo JS Puro) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, deleteDoc, onSnapshot, collection, query, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- VARIÁVEIS GLOBAIS DE AMBIENTE ---
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        // --- VARIÁVEIS DE ESTADO ---
        let db;
        let auth;
        let userId = null;
        let currentEditingProduct = null;
        let fileToUpload = null;
        let currentObjectURL = null; // Para cleanup da URL de pré-visualização

        // --- REFERÊNCIAS DOM ---
        const productList = document.getElementById('product-list');
        const modalBackdrop = document.getElementById('edit-modal-backdrop');
        const productForm = document.getElementById('product-form');
        const fileInput = document.getElementById('file-upload');
        const fileLabel = document.getElementById('file-label');
        const fileStatus = document.getElementById('file-status');
        const currentImage = document.getElementById('current-image');
        const modalTitle = document.getElementById('modal-title');
        const saveBtn = document.getElementById('save-btn');
        const userDisplay = document.getElementById('user-display');
        const stockTitle = document.getElementById('stock-title');

        // --- UTILS ---

        // Mock de função de upload (simula o upload e retorna um URL)
        const mockUploadImage = (file) => {
            return new Promise((resolve) => {
                setTimeout(() => {
                    console.log(`Simulando upload do arquivo: ${file.name}`);
                    const placeholderText = encodeURIComponent(file.name.substring(0, 10) || 'Produto');
                    resolve(`https://placehold.co/400x300/a3e635/1a2e05?text=${placeholderText}`);
                }, 1000);
            });
        };

        // Função para limpar o Object URL temporário
        const cleanupObjectURL = () => {
            if (currentObjectURL) {
                URL.revokeObjectURL(currentObjectURL);
                currentObjectURL = null;
            }
        };


        // --- FIREBASE INIT & AUTH ---

        const initFirebase = async () => {
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                    } else {
                        if (initialAuthToken) {
                            const userCredential = await signInWithCustomToken(auth, initialAuthToken);
                            userId = userCredential.user.uid;
                        } else {
                            const userCredential = await signInAnonymously(auth);
                            userId = userCredential.user.uid;
                        }
                    }
                    userDisplay.innerHTML = `Usuário: <span class="font-mono text-yellow-400 break-all">${userId}</span>`;
                    startListeningToProducts();
                });
            } catch (e) {
                console.error("Erro ao inicializar Firebase:", e);
                userDisplay.textContent = "Erro de autenticação";
            }
        };

        // --- RENDERIZAÇÃO DOM ---

        const renderProducts = (products) => {
            productList.innerHTML = '';
            stockTitle.textContent = `Estoque (${products.length})`;
            
            if (products.length === 0) {
                productList.innerHTML = `
                    <div class="text-center py-10 bg-white rounded-xl shadow-md col-span-full">
                        <p class="text-gray-500">Nenhum produto cadastrado ainda. Comece a adicionar!</p>
                    </div>
                `;
                return;
            }

            products.forEach(product => {
                const productCard = document.createElement('div');
                productCard.className = "bg-white rounded-xl shadow-lg overflow-hidden transition duration-300 hover:shadow-xl flex flex-col";
                productCard.innerHTML = `
                    <div class="relative h-48 bg-gray-200">
                        <img 
                            src="${product.imageUrl || "https://placehold.co/400x300/e5e7eb/4b5563?text=SEM+FOTO"}" 
                            alt="Imagem de ${product.nome}" 
                            class="w-full h-full object-cover"
                            onerror="this.onerror=null;this.src='https://placehold.co/400x300/e5e7eb/4b5563?text=ERRO+NA+FOTO';"
                        />
                    </div>
                    <div class="p-4 flex flex-col flex-grow">
                        <h3 class="text-xl font-bold text-gray-900 mb-2 truncate">${product.nome}</h3>
                        <p class="text-2xl font-extrabold text-green-700 mb-3">
                            R$ ${parseFloat(product.preco).toFixed(2).replace('.', ',')}
                        </p>
                        <p class="text-sm text-gray-600 flex-grow mb-4 line-clamp-2">${product.descricao || 'Sem descrição.'}</p>
                        <div class="flex justify-end space-x-2 mt-auto">
                            <button data-id="${product.id}" class="edit-btn flex-1 py-2 bg-yellow-500 text-white font-semibold rounded-lg hover:bg-yellow-600 transition duration-200 text-sm">
                                Editar
                            </button>
                            <button data-id="${product.id}" class="delete-btn flex-1 py-2 bg-red-600 text-white font-semibold rounded-lg hover:bg-red-700 transition duration-200 text-sm">
                                Deletar
                            </button>
                        </div>
                    </div>
                `;
                productList.appendChild(productCard);
            });

            // Adicionar Listeners aos botões de Edição e Deleção
            document.querySelectorAll('.edit-btn').forEach(btn => btn.addEventListener('click', (e) => openModal(e.target.dataset.id)));
            document.querySelectorAll('.delete-btn').forEach(btn => btn.addEventListener('click', (e) => deleteProduct(e.target.dataset.id)));
        };

        // --- LÓGICA DO MODAL ---

        const openModal = async (productId = null) => {
            cleanupObjectURL(); // Limpa URLs anteriores
            fileToUpload = null;
            productForm.reset(); // Limpa o formulário

            if (productId) {
                // Modo Edição
                const productsPath = `/artifacts/${appId}/users/${userId}/products`;
                const productRef = doc(db, productsPath, productId);
                const docSnap = await getDoc(productRef);
                
                if (!docSnap.exists()) {
                    console.error("Produto não encontrado.");
                    return;
                }
                
                const productData = docSnap.data();
                currentEditingProduct = { id: productId, ...productData };
                
                modalTitle.textContent = 'Editar Produto';
                saveBtn.textContent = 'Salvar Alterações';
                
                // Preencher Formulário
                document.getElementById('nome').value = productData.nome || '';
                document.getElementById('descricao').value = productData.descricao || '';
                document.getElementById('preco').value = parseFloat(productData.preco).toFixed(2);
                
                // Configurar Imagem
                currentImage.src = productData.imageUrl || "https://placehold.co/96x96/e5e7eb/4b5563?text=SEM+FOTO";
                fileStatus.textContent = productData.imageUrl ? 'Foto atual carregada.' : 'Nenhum ficheiro selecionado.';
                fileLabel.textContent = productData.imageUrl ? 'Alterar Foto' : 'Adicionar Foto';

            } else {
                // Modo Criação
                currentEditingProduct = { id: null, nome: '', descricao: '', preco: 0.0, imageUrl: '' };
                modalTitle.textContent = 'Novo Produto';
                saveBtn.textContent = 'Cadastrar Produto';
                currentImage.src = "https://placehold.co/96x96/e5e7eb/4b5563?text=?";
                fileStatus.textContent = 'Nenhum ficheiro selecionado.';
                fileLabel.textContent = 'Selecionar Arquivo';
            }

            modalBackdrop.style.display = 'flex';
        };

        const closeModal = () => {
            modalBackdrop.style.display = 'none';
            cleanupObjectURL();
            fileToUpload = null;
            currentEditingProduct = null;
        };

        // --- FIREBASE OPERAÇÕES ---

        const startListeningToProducts = () => {
            if (!db || !userId) return;

            const productsPath = `/artifacts/${appId}/users/${userId}/products`;
            const q = query(collection(db, productsPath));

            onSnapshot(q, (snapshot) => {
                const productsData = [];
                snapshot.forEach((doc) => {
                    productsData.push({ id: doc.id, ...doc.data() });
                });
                renderProducts(productsData.sort((a, b) => a.nome.localeCompare(b.nome)));
            }, (error) => {
                console.error("Erro ao carregar produtos:", error);
            });
        };

        const saveProduct = async (e) => {
            e.preventDefault();

            const loadingOverlay = createLoadingOverlay();
            document.body.appendChild(loadingOverlay);

            const nome = document.getElementById('nome').value.trim();
            const descricao = document.getElementById('descricao').value.trim();
            const preco = parseFloat(document.getElementById('preco').value) || 0.0;
            let updatedImageUrl = currentEditingProduct.imageUrl || '';

            // 1. Lidar com o Upload da Imagem, se um novo ficheiro foi selecionado
            if (fileToUpload) {
                try {
                    updatedImageUrl = await mockUploadImage(fileToUpload);
                } catch (error) {
                    console.error("Erro no upload da imagem:", error);
                    alert("Erro ao enviar imagem. Tente novamente."); // Usando alert apenas neste mock de erro
                    loadingOverlay.remove();
                    return;
                }
            }

            // 2. Preparar dados
            const productDataToSave = {
                nome: nome,
                descricao: descricao,
                preco: preco,
                imageUrl: updatedImageUrl,
                updatedAt: new Date(),
            };

            const productsPath = `/artifacts/${appId}/users/${userId}/products`;

            try {
                if (currentEditingProduct.id) {
                    // ATUALIZAÇÃO
                    const productRef = doc(db, productsPath, currentEditingProduct.id);
                    await updateDoc(productRef, productDataToSave);
                    console.log("Produto atualizado com sucesso!");
                } else {
                    // CRIAÇÃO
                    const newProductRef = doc(collection(db, productsPath));
                    await setDoc(newProductRef, { 
                        ...productDataToSave, 
                        createdAt: new Date() 
                    });
                    console.log("Produto criado com sucesso!");
                }

                closeModal();
            } catch (error) {
                console.error("Erro ao salvar o produto:", error);
                // NOTA: Em produção, usar um modal de erro, não console.error
            } finally {
                loadingOverlay.remove();
            }
        };

        const deleteProduct = async (id) => {
            if (!confirm("Tem certeza que deseja deletar este produto?")) return; // Usando confirm para manter a simplicidade

            const productsPath = `/artifacts/${appId}/users/${userId}/products`;
            const productRef = doc(db, productsPath, id);
            
            try {
                await deleteDoc(productRef);
                console.log(`Produto ${id} deletado.`);
            } catch (error) {
                console.error("Erro ao deletar produto:", error);
            }
        };


        // --- LISTENERS ---

        productForm.addEventListener('submit', saveProduct);
        document.getElementById('new-product-btn').addEventListener('click', () => openModal(null));
        document.getElementById('cancel-btn').addEventListener('click', closeModal);

        fileInput.addEventListener('change', (e) => {
            fileToUpload = e.target.files[0];
            cleanupObjectURL();
            
            if (fileToUpload) {
                fileStatus.textContent = `Novo ficheiro selecionado: ${fileToUpload.name}`;
                fileLabel.textContent = 'Alterar Foto';
                // Pré-visualização local
                currentObjectURL = URL.createObjectURL(fileToUpload);
                currentImage.src = currentObjectURL;
            } else {
                fileStatus.textContent = 'Nenhum ficheiro selecionado.';
                fileLabel.textContent = currentEditingProduct.imageUrl ? 'Alterar Foto' : 'Adicionar Foto';
                currentImage.src = currentEditingProduct.imageUrl || "https://placehold.co/96x96/e5e7eb/4b5563?text=?";
            }
        });

        // Adicionar um listener de clique no backdrop para fechar o modal (opcional)
        modalBackdrop.addEventListener('click', (e) => {
            if (e.target.id === 'edit-modal-backdrop') {
                closeModal();
            }
        });

        // --- COMPONENTE DE CARREGAMENTO SIMPLES (Nativo JS) ---

        function createLoadingOverlay() {
            const div = document.createElement('div');
            div.className = 'fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50';
            div.innerHTML = `
                <div class="flex flex-col items-center p-6 bg-white rounded-lg shadow-xl">
                    <svg class="animate-spin -ml-1 mr-3 h-8 w-8 text-indigo-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    <p class="mt-3 text-gray-700 font-medium">Processando...</p>
                </div>
            `;
            return div;
        }

        // --- INICIALIZAÇÃO PRINCIPAL ---
        window.addEventListener('load', initFirebase);
    </script>
</body>
</html>
